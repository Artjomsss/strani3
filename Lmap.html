<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∏–∫—Å–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ï–≤—Ä–æ–ø—ã</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ) ... */
    </style>
</head>
<body>
    <!-- ... (–≤—Å—è HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ) ... -->

    <script>
        // ... (–≤—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –∏ –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ) ...

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–∏–∫—Å–µ–ª—è –° –°–û –°–ú–ï–©–ï–ù–ò–ï–ú
        function getPixelCoordinates(x, y) {
            const pixelMap = document.getElementById('pixel-map');
            const rect = pixelMap.getBoundingClientRect();
            
            // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç - –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å 25x25, –æ—Ç—Å—Ç—É–ø—ã 20px
            const pixelLeft = x * 25 + 20;
            const pixelTop = y * 25 + 20;
            
            return { left: pixelLeft, top: pixelTop };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–ª–∏–∫–∞
        function getExactCoordinates(e) {
            const pixelMap = document.getElementById('pixel-map');
            const rect = pixelMap.getBoundingClientRect();
            
            const relativeX = e.clientX - rect.left - 20; // 20px padding
            const relativeY = e.clientY - rect.top - 20;  // 20px padding
            
            const x = Math.floor(relativeX / 25);
            const y = Math.floor(relativeY / 25);
            
            return { x, y };
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —é–Ω–∏—Ç–∞–º–∏ - –° –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ú –°–ú–ï–©–ï–ù–ò–ï–ú –í–õ–ï–í–û
        function renderUnit(unit) {
            let unitElement = document.getElementById(unit.id);
            if (!unitElement) {
                unitElement = document.createElement('div');
                unitElement.id = unit.id;
                document.getElementById('pixel-map').appendChild(unitElement);
            }
            
            unitElement.className = `unit soldier ${unit.isMoving ? 'moving' : ''}`;
            
            // –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –°–û –°–ú–ï–©–ï–ù–ò–ï–ú –í–õ–ï–í–û
            const pixelPos = getPixelCoordinates(unit.position.x, unit.position.y);
            const centerOffset = 2.5; // (25 - 20) / 2
            const LEFT_OFFSET = -2; // –°–ú–ï–©–ï–ù–ò–ï –í–õ–ï–í–û –ù–ê 2px
            
            unitElement.style.left = (pixelPos.left + centerOffset + LEFT_OFFSET) + 'px';
            unitElement.style.top = (pixelPos.top + centerOffset) + 'px';
            unitElement.style.background = '#3498db';
            unitElement.innerHTML = `üë•<div style="font-size:8px">${unit.size}</div>`;
            
            console.log(`üìç –Æ–Ω–∏—Ç ${unit.id} –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ ${unit.position.x},${unit.position.y} —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º ${LEFT_OFFSET}px`);
        }

        function createGhostUnit(unit) {
            const pixelMap = document.getElementById('pixel-map');
            const ghost = document.createElement('div');
            
            ghost.className = `unit soldier ghost`;
            
            const pixelPos = getPixelCoordinates(unit.position.x, unit.position.y);
            const centerOffset = 2.5;
            const LEFT_OFFSET = -2; // –°–ú–ï–©–ï–ù–ò–ï –í–õ–ï–í–û –ù–ê 2px
            
            ghost.style.left = (pixelPos.left + centerOffset + LEFT_OFFSET) + 'px';
            ghost.style.top = (pixelPos.top + centerOffset) + 'px';
            ghost.style.background = '#3498db';
            ghost.innerHTML = `üë•<div style="font-size:8px">${unit.size}</div>`;
            
            pixelMap.appendChild(ghost);
            gameState.ghostUnit = ghost;
        }

        function updateGhostPosition(x, y) {
            if (gameState.ghostUnit) {
                const pixelPos = getPixelCoordinates(x, y);
                const centerOffset = 2.5;
                const LEFT_OFFSET = -2; // –°–ú–ï–©–ï–ù–ò–ï –í–õ–ï–í–û –ù–ê 2px
                
                gameState.ghostUnit.style.left = (pixelPos.left + centerOffset + LEFT_OFFSET) + 'px';
                gameState.ghostUnit.style.top = (pixelPos.top + centerOffset) + 'px';
            }
        }

        // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –Ω–æ –æ–±–Ω–æ–≤–∏–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–≤–∏–∂–µ–Ω–∏—è) ...

        function startMovementAnimation(unit) {
            const unitElement = document.getElementById(unit.id);
            if (!unitElement) return;
            
            const startTime = Date.now();
            const startPos = {...unit.position};
            const targetPos = unit.targetPosition;
            const LEFT_OFFSET = -2; // –°–ú–ï–©–ï–ù–ò–ï –í–õ–ï–í–û –ù–ê 2px
            
            function animateMove() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / unit.moveDuration, 1);
                
                if (progress < 1) {
                    const currentX = startPos.x + (targetPos.x - startPos.x) * progress;
                    const currentY = startPos.y + (targetPos.y - startPos.y) * progress;
                    
                    const pixelPos = getPixelCoordinates(currentX, currentY);
                    const centerOffset = 2.5;
                    
                    unitElement.style.left = (pixelPos.left + centerOffset + LEFT_OFFSET) + 'px';
                    unitElement.style.top = (pixelPos.top + centerOffset) + 'px';
                    
                    requestAnimationFrame(animateMove);
                } else {
                    unit.isMoving = false;
                    unit.position = targetPos;
                    unit.targetPosition = null;
                    
                    if (unitElement) {
                        unitElement.classList.remove('moving');
                        const finalPixelPos = getPixelCoordinates(targetPos.x, targetPos.y);
                        const centerOffset = 2.5;
                        unitElement.style.left = (finalPixelPos.left + centerOffset + LEFT_OFFSET) + 'px';
                        unitElement.style.top = (finalPixelPos.top + centerOffset) + 'px';
                    }
                    
                    checkForCapture(unit);
                    updateGameStats();
                    saveToDatabase('units/' + unit.id, unit);
                    
                    console.log(`‚úÖ –ê—Ä–º–∏—è ${unit.id} –ø—Ä–∏–±—ã–ª–∞ –≤ ${targetPos.x},${targetPos.y}`);
                }
            }
            
            animateMove();
        }

        // –û–±–Ω–æ–≤–∏–º —Ç–∞–∫–∂–µ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–µ –º–µ–Ω—é —á—Ç–æ–±—ã –æ–Ω–æ —Ç–æ–∂–µ —Å–º–µ—â–∞–ª–æ—Å—å
        function createRadialMenu(unit, x, y) {
            const radialMenu = document.getElementById('radial-menu');
            radialMenu.innerHTML = '<div class="radial-menu-center">‚öôÔ∏è</div>';
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è
            const pixelPos = getPixelCoordinates(x, y);
            const centerOffset = 2.5;
            const LEFT_OFFSET = -2; // –°–ú–ï–©–ï–ù–ò–ï –í–õ–ï–í–û –ù–ê 2px
            
            radialMenu.style.left = (pixelPos.left + centerOffset + LEFT_OFFSET - 30) + 'px';
            radialMenu.style.top = (pixelPos.top + centerOffset - 30) + 'px';
            
            // ... (–æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ) ...
        }

        // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    </script>
</body>
</html>

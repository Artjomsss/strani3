<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–ª–±–∞–Ω–∏—è</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    .notification.error {
      background: #e74c3c;
    }
    .notification.warning {
      background: #f39c12;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #2a2a40;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      border: 1px solid #3a3a5a;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 15px;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .modal-buttons .confirm {
      background: #27ae60;
      color: white;
    }
    .modal-buttons .cancel {
      background: #7f8c8d;
      color: white;
    }
  </style>
</head>
<body>
  <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π -->
  
  <!-- –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
  <div id="alliance-modal" class="modal">
    <div class="modal-content">
      <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞</h3>
      <p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞:</p>
      <input type="text" id="alliance-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞" style="width: 100%; padding: 8px; margin: 10px 0; background: #1f1f30; border: 1px solid #3a3a5a; color: white; border-radius: 5px;">
      <div class="modal-buttons">
        <button class="cancel" onclick="closeAllianceModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="confirm" onclick="confirmCreateAlliance()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="war-modal" class="modal">
    <div class="modal-content">
      <h3>–û–±—ä—è–≤–ª–µ–Ω–∏–µ –≤–æ–π–Ω—ã</h3>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤–æ–π–Ω—ã:</p>
      <select id="war-target" style="width: 100%; padding: 8px; margin: 10px 0; background: #1f1f30; border: 1px solid #3a3a5a; color: white; border-radius: 5px;">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É --</option>
        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JavaScript -->
      </select>
      <div class="modal-buttons">
        <button class="cancel" onclick="closeWarModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="confirm" onclick="confirmDeclareWar()">–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration (–æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º)
    const firebaseConfig = {
      apiKey: "AIzaSyDRUoIzXpwwAGYM0qciAYdQm-wtMKqLsVs",
      authDomain: "strani3.firebaseapp.com",
      databaseURL: "https://strani3-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "strani3",
      storageBucket: "strani3.firebasestorage.app",
      messagingSenderId: "225168183800",
      appId: "1:225168183800:web:825e782a35bccca89d460d",
      measurementId: "G-3NKBET5R9J"
    };

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let db;
    let incomeTimer;
    let lastGoldAmount = 0;
    let serverTimeOffset = 0;
    let isTimeSynced = false;
    const country = "albania";

    // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }

    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    function openAllianceModal() {
      document.getElementById('alliance-modal').style.display = 'flex';
    }

    function closeAllianceModal() {
      document.getElementById('alliance-modal').style.display = 'none';
      document.getElementById('alliance-name').value = '';
    }

    function openWarModal() {
      const select = document.getElementById('war-target');
      select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É --</option>';
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω (–∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â—É—é)
      const countries = [
        'andorra', 'austria', 'belarus', 'belgium', 'bulgaria', 'croatia', 
        'czechia', 'denmark', 'estonia', 'finland', 'france', 'germany', 
        'greece', 'hungary', 'iceland', 'ireland', 'italy', 'latvia', 
        'lithuania', 'luxembourg', 'malta', 'moldova', 'monaco', 'montenegro', 
        'netherlands', 'north_macedonia', 'norway', 'poland', 'portugal'
      ];
      
      countries.forEach(countryName => {
        if (countryName !== country) {
          const option = document.createElement('option');
          option.value = countryName;
          option.textContent = countryName;
          select.appendChild(option);
        }
      });
      
      document.getElementById('war-modal').style.display = 'flex';
    }

    function closeWarModal() {
      document.getElementById('war-modal').style.display = 'none';
    }

    // –°–ò–°–¢–ï–ú–ê –ê–õ–¨–Ø–ù–°–û–í
    async function createAlliance() {
      if (!checkDB()) {
        showNotification('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∞–ª—å—è–Ω—Å–∞
      const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
      if (allianceSnapshot.exists()) {
        showNotification('–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∞–ª—å—è–Ω—Å–µ!', 'warning');
        return;
      }

      openAllianceModal();
    }

    async function confirmCreateAlliance() {
      const allianceName = document.getElementById('alliance-name').value.trim();
      if (!allianceName) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞', 'warning');
        return;
      }

      try {
        const allianceData = {
          name: allianceName,
          creator: country,
          createdAt: new Date().toISOString(),
          members: {
            [country]: true
          }
        };

        await db.ref(`alliances/${country}_alliance`).set(allianceData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
        await db.ref(`countries/${country}`).update({
          alliance: country + '_alliance',
          lastUpdated: new Date().toISOString()
        });

        closeAllianceModal();
        showNotification(`–ê–ª—å—è–Ω—Å "${allianceName}" —Å–æ–∑–¥–∞–Ω!`);
        loadAllianceInfo();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º —Å—Ç—Ä–∞–Ω–∞–º
        sendAllianceNotification(`–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–ª—å—è–Ω—Å: ${allianceName}`, 'system');
        
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å—è–Ω—Å–∞: ' + error.message, 'error');
      }
    }

    async function inviteToAlliance(targetCountry) {
      if (!checkDB()) return;

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞
        const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
        if (!allianceSnapshot.exists()) {
          showNotification('–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∞–ª—å—è–Ω—Å–µ!', 'warning');
          return;
        }

        const allianceData = allianceSnapshot.val();
        const allianceId = Object.keys(allianceData)[0];
        const alliance = allianceData[allianceId];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å)
        if (alliance.creator !== country) {
          showNotification('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∞–ª—å—è–Ω—Å–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', 'warning');
          return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
        const invitationId = `${country}_to_${targetCountry}_${Date.now()}`;
        const invitation = {
          type: 'alliance_invite',
          from: country,
          to: targetCountry,
          allianceId: allianceId,
          allianceName: alliance.name,
          timestamp: new Date().toISOString(),
          status: 'pending'
        };

        await db.ref(`mail/${targetCountry}/${invitationId}`).set(invitation);
        showNotification(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${targetCountry}`);

      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    async function leaveAlliance() {
      if (!checkDB()) return;

      try {
        const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
        if (!allianceSnapshot.exists()) {
          showNotification('–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∞–ª—å—è–Ω—Å–µ!', 'warning');
          return;
        }

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∞–ª—å—è–Ω—Å?')) return;

        const allianceData = allianceSnapshot.val();
        const allianceId = Object.keys(allianceData)[0];
        const alliance = allianceData[allianceId];

        // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–ª—å—è–Ω—Å–∞
        await db.ref(`alliances/${allianceId}/members/${country}`).remove();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
        await db.ref(`countries/${country}`).update({
          alliance: null,
          lastUpdated: new Date().toISOString()
        });

        showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∞–ª—å—è–Ω—Å');
        loadAllianceInfo();

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        sendAllianceNotification(`${country} –ø–æ–∫–∏–Ω—É–ª –∞–ª—å—è–Ω—Å`, 'system');

      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–ª—å—è–Ω—Å–∞: ' + error.message, 'error');
      }
    }

    // –°–ò–°–¢–ï–ú–ê –í–û–ô–ù
    async function declareWar() {
      if (!checkDB()) {
        showNotification('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
      }
      openWarModal();
    }

    async function confirmDeclareWar() {
      const targetCountry = document.getElementById('war-target').value;
      if (!targetCountry) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É', 'warning');
        return;
      }

      try {
        const warId = `${country}_vs_${targetCountry}_${Date.now()}`;
        const warData = {
          participants: {
            [country]: true,
            [targetCountry]: true
          },
          declaredBy: country,
          startTime: new Date().toISOString(),
          status: 'active'
        };

        await db.ref(`wars/${warId}`).set(warData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω
        await db.ref(`countries/${country}/wars/${warId}`).set(true);
        await db.ref(`countries/${targetCountry}/wars/${warId}`).set(true);

        closeWarModal();
        showNotification(`–í–æ–π–Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∞ ${targetCountry}!`, 'warning');

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ–π–Ω–µ
        sendWarNotification(targetCountry, `${country} –æ–±—ä—è–≤–∏–ª –≤–∞–º –≤–æ–π–Ω—É!`);

      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤–æ–π–Ω—ã: ' + error.message, 'error');
      }
    }

    // –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    async function sendAllianceNotification(message, type = 'alliance') {
      const mailId = `alliance_${Date.now()}`;
      const mailData = {
        type: type,
        subject: message,
        timestamp: new Date().toISOString(),
        read: false
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∞–ª—å—è–Ω—Å–∞
      const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
      if (allianceSnapshot.exists()) {
        const allianceData = allianceSnapshot.val();
        const allianceId = Object.keys(allianceData)[0];
        const members = allianceData[allianceId].members;

        Object.keys(members).forEach(member => {
          if (member !== country) {
            db.ref(`mail/${member}/${mailId}`).set(mailData);
          }
        });
      }
    }

    async function sendWarNotification(targetCountry, message) {
      const mailId = `war_${Date.now()}`;
      const mailData = {
        type: 'war',
        subject: message,
        from: country,
        timestamp: new Date().toISOString(),
        read: false
      };

      await db.ref(`mail/${targetCountry}/${mailId}`).set(mailData);
    }

    // –ó–ê–ì–†–£–ó–ö–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò –û–ë –ê–õ–¨–Ø–ù–°–ê–• –ò –í–û–ô–ù–ê–•
    async function loadAllianceInfo() {
      if (!checkDB()) return;

      try {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–ª—å—è–Ω—Å–µ
        const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
        const allianceContainer = document.getElementById('alliance-container');
        
        if (allianceSnapshot.exists()) {
          const allianceData = allianceSnapshot.val();
          const allianceId = Object.keys(allianceData)[0];
          const alliance = allianceData[allianceId];
          
          let html = `<div class="alliance-info">
            <h3>–ê–ª—å—è–Ω—Å: ${alliance.name}</h3>
            <p>–°–æ–∑–¥–∞—Ç–µ–ª—å: ${alliance.creator}</p>
            <div class="alliance-members">
              <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h4>`;
          
          Object.keys(alliance.members).forEach(member => {
            const isCreator = member === alliance.creator;
            html += `<div class="member-item">
              <span>${member} ${isCreator ? 'üëë' : ''}</span>
              ${isCreator && member === country ? `<button class="kick-btn" onclick="kickMember('${member}')" disabled>–ò—Å–∫–ª—é—á–∏—Ç—å</button>` : 
                alliance.creator === country ? `<button class="kick-btn" onclick="kickMember('${member}')">–ò—Å–∫–ª—é—á–∏—Ç—å</button>` : ''}
            </div>`;
          });
          
          html += `</div></div>`;
          allianceContainer.innerHTML = html;
        } else {
          allianceContainer.innerHTML = '';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–æ–π–Ω–∞—Ö
        const warsSnapshot = await db.ref(`countries/${country}/wars`).once('value');
        const warContainer = document.getElementById('war-container');
        
        if (warsSnapshot.exists()) {
          const wars = warsSnapshot.val();
          let html = `<div class="war-info"><h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–π–Ω—ã:</h3>`;
          
          for (const warId in wars) {
            const warSnapshot = await db.ref(`wars/${warId}`).once('value');
            const war = warSnapshot.val();
            if (war && war.status === 'active') {
              const opponents = Object.keys(war.participants).filter(p => p !== country);
              html += `<p>–í–æ–π–Ω–∞ —Å: ${opponents.join(', ')}</p>`;
            }
          }
          
          html += `</div>`;
          warContainer.innerHTML = html;
        } else {
          warContainer.innerHTML = '';
        }

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–ª—å—è–Ω—Å–∞—Ö/–≤–æ–π–Ω–∞—Ö:', error);
      }
    }

    // –ó–ê–ì–†–£–ó–ö–ê –ü–û–ß–¢–´
    async function loadMail() {
      if (!checkDB()) return;

      try {
        const mailSnapshot = await db.ref(`mail/${country}`).orderByChild('timestamp').once('value');
        const mailContainer = document.getElementById('mail-container');
        
        if (!mailSnapshot.exists()) {
          mailContainer.innerHTML = '<div class="mail-item">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
          return;
        }

        let html = '';
        const mailData = mailSnapshot.val();
        
        Object.keys(mailData).sort((a, b) => new Date(mailData[b].timestamp) - new Date(mailData[a].timestamp))
          .forEach(mailId => {
            const mail = mailData[mailId];
            const date = new Date(mail.timestamp).toLocaleString();
            
            html += `<div class="mail-item">
              <div class="mail-sender">${mail.from || '–°–∏—Å—Ç–µ–º–∞'}</div>
              <div class="mail-subject">${mail.subject}</div>
              <span class="mail-type ${mail.type}">${mail.type}</span>
              <div class="mail-date">${date}</div>`;
            
            if (mail.type === 'alliance_invite' && mail.status === 'pending') {
              html += `<div class="mail-actions">
                <button class="accept-btn" onclick="acceptInvitation('${mailId}', '${mail.allianceId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="decline-btn" onclick="declineInvitation('${mailId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
              </div>`;
            }
            
            html += `</div>`;
          });
        
        mailContainer.innerHTML = html;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—á—Ç—ã:', error);
      }
    }

    // –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–ò–ì–õ–ê–®–ï–ù–ò–ô
    async function acceptInvitation(mailId, allianceId) {
      try {
        // –ü—Ä–∏–Ω–∏–º–∞–µ–º –≤ –∞–ª—å—è–Ω—Å
        await db.ref(`alliances/${allianceId}/members/${country}`).set(true);
        await db.ref(`countries/${country}`).update({
          alliance: allianceId,
          lastUpdated: new Date().toISOString()
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        await db.ref(`mail/${country}/${mailId}/status`).set('accepted');
        
        showNotification('–í—ã –ø—Ä–∏–Ω—è–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∞–ª—å—è–Ω—Å!');
        loadAllianceInfo();
        loadMail();
        
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    async function declineInvitation(mailId) {
      try {
        await db.ref(`mail/${country}/${mailId}/status`).set('declined');
        showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
        loadMail();
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message, 'error');
      }
    }

    // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –î–û–•–û–î–ê
    async function upgradeIncome() {
      if (!checkDB()) {
        showNotification('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
      }
      
      try {
        const snapshot = await db.ref("countries/" + country).once("value");
        const data = snapshot.val();
        
        if (!data) {
          showNotification('–î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
          return;
        }
        
        const currentGold = data.gold || 0;
        const currentIncome = data.income || 0;
        const upgradeCost = Math.floor(500 + (currentIncome * 10)); // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
        
        if (currentGold < upgradeCost) {
          showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ: ${upgradeCost}`, 'warning');
          return;
        }
        
        if (confirm(`–£–ª—É—á—à–∏—Ç—å –¥–æ—Ö–æ–¥ –Ω–∞ 10 –∑–æ–ª–æ—Ç–∞/—á–∞—Å –∑–∞ ${upgradeCost} –∑–æ–ª–æ—Ç–∞?`)) {
          const newIncome = currentIncome + 10;
          const newGold = currentGold - upgradeCost;
          
          await db.ref(`countries/${country}`).update({
            income: newIncome,
            gold: newGold,
            lastUpdated: new Date().toISOString()
          });
          
          showNotification(`‚úÖ –î–æ—Ö–æ–¥ —É–ª—É—á—à–µ–Ω! –¢–µ–ø–µ—Ä—å: ${newIncome}/—á–∞—Å`);
        }
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞: ' + error.message, 'error');
      }
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (initializeFirebase, checkDB, initializeCountryData, 
    // calculateOfflineIncome, loadData, startIncomeTimer, etc.) –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º
    async function initialize() {
      if (initializeFirebase()) {
        await getServerTime();
        await initializeCountryData();
        loadData();
        loadAllianceInfo();
        loadMail();
        startIncomeTimer();
        
        setInterval(updateTimeDisplay, 1000);
        updateTimeDisplay();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
          loadAllianceInfo();
          loadMail();
        }, 30000);
      }
    }

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
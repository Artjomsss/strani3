<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Албания</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    /* Стили остаются прежними, добавляем только новые классы */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    .notification.error {
      background: #e74c3c;
    }
    .notification.warning {
      background: #f39c12;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #2a2a40;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      border: 1px solid #3a3a5a;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 15px;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .modal-buttons .confirm {
      background: #27ae60;
      color: white;
    }
    .modal-buttons .cancel {
      background: #7f8c8d;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Остальная HTML структура остается прежней -->
  
  <!-- Добавляем модальные окна -->
  <div id="alliance-modal" class="modal">
    <div class="modal-content">
      <h3>Создание альянса</h3>
      <p>Введите название альянса:</p>
      <input type="text" id="alliance-name" placeholder="Название альянса" style="width: 100%; padding: 8px; margin: 10px 0; background: #1f1f30; border: 1px solid #3a3a5a; color: white; border-radius: 5px;">
      <div class="modal-buttons">
        <button class="cancel" onclick="closeAllianceModal()">Отмена</button>
        <button class="confirm" onclick="confirmCreateAlliance()">Создать</button>
      </div>
    </div>
  </div>

  <div id="war-modal" class="modal">
    <div class="modal-content">
      <h3>Объявление войны</h3>
      <p>Выберите страну для объявления войны:</p>
      <select id="war-target" style="width: 100%; padding: 8px; margin: 10px 0; background: #1f1f30; border: 1px solid #3a3a5a; color: white; border-radius: 5px;">
        <option value="">-- Выберите страну --</option>
        <!-- Опции будут заполнены JavaScript -->
      </select>
      <div class="modal-buttons">
        <button class="cancel" onclick="closeWarModal()">Отмена</button>
        <button class="confirm" onclick="confirmDeclareWar()">Объявить войну</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration (остается прежним)
    const firebaseConfig = {
      apiKey: "AIzaSyDRUoIzXpwwAGYM0qciAYdQm-wtMKqLsVs",
      authDomain: "strani3.firebaseapp.com",
      databaseURL: "https://strani3-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "strani3",
      storageBucket: "strani3.firebasestorage.app",
      messagingSenderId: "225168183800",
      appId: "1:225168183800:web:825e782a35bccca89d460d",
      measurementId: "G-3NKBET5R9J"
    };

    // Глобальные переменные
    let db;
    let incomeTimer;
    let lastGoldAmount = 0;
    let serverTimeOffset = 0;
    let isTimeSynced = false;
    const country = "albania";

    // Система уведомлений
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }

    // Модальные окна
    function openAllianceModal() {
      document.getElementById('alliance-modal').style.display = 'flex';
    }

    function closeAllianceModal() {
      document.getElementById('alliance-modal').style.display = 'none';
      document.getElementById('alliance-name').value = '';
    }

    function openWarModal() {
      const select = document.getElementById('war-target');
      select.innerHTML = '<option value="">-- Выберите страну --</option>';
      
      // Заполняем список стран (исключая текущую)
      const countries = [
        'andorra', 'austria', 'belarus', 'belgium', 'bulgaria', 'croatia', 
        'czechia', 'denmark', 'estonia', 'finland', 'france', 'germany', 
        'greece', 'hungary', 'iceland', 'ireland', 'italy', 'latvia', 
        'lithuania', 'luxembourg', 'malta', 'moldova', 'monaco', 'montenegro', 
        'netherlands', 'north_macedonia', 'norway', 'poland', 'portugal'
      ];
      
      countries.forEach(countryName => {
        if (countryName !== country) {
          const option = document.createElement('option');
          option.value = countryName;
          option.textContent = countryName;
          select.appendChild(option);
        }
      });
      
      document.getElementById('war-modal').style.display = 'flex';
    }

    function closeWarModal() {
      document.getElementById('war-modal').style.display = 'none';
    }

    // СИСТЕМА АЛЬЯНСОВ
    async function createAlliance() {
      if (!checkDB()) {
        showNotification('База данных не доступна', 'error');
        return;
      }

      // Проверяем, нет ли уже альянса
      const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
      if (allianceSnapshot.exists()) {
        showNotification('Вы уже состоите в альянсе!', 'warning');
        return;
      }

      openAllianceModal();
    }

    async function confirmCreateAlliance() {
      const allianceName = document.getElementById('alliance-name').value.trim();
      if (!allianceName) {
        showNotification('Введите название альянса', 'warning');
        return;
      }

      try {
        const allianceData = {
          name: allianceName,
          creator: country,
          createdAt: new Date().toISOString(),
          members: {
            [country]: true
          }
        };

        await db.ref(`alliances/${country}_alliance`).set(allianceData);
        
        // Обновляем данные страны
        await db.ref(`countries/${country}`).update({
          alliance: country + '_alliance',
          lastUpdated: new Date().toISOString()
        });

        closeAllianceModal();
        showNotification(`Альянс "${allianceName}" создан!`);
        loadAllianceInfo();
        
        // Отправляем уведомление другим странам
        sendAllianceNotification(`Создан новый альянс: ${allianceName}`, 'system');
        
      } catch (error) {
        showNotification('Ошибка создания альянса: ' + error.message, 'error');
      }
    }

    async function inviteToAlliance(targetCountry) {
      if (!checkDB()) return;

      try {
        // Проверяем существование альянса
        const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
        if (!allianceSnapshot.exists()) {
          showNotification('Вы не состоите в альянсе!', 'warning');
          return;
        }

        const allianceData = allianceSnapshot.val();
        const allianceId = Object.keys(allianceData)[0];
        const alliance = allianceData[allianceId];

        // Проверяем права (только создатель может приглашать)
        if (alliance.creator !== country) {
          showNotification('Только создатель альянса может приглашать участников', 'warning');
          return;
        }

        // Отправляем приглашение
        const invitationId = `${country}_to_${targetCountry}_${Date.now()}`;
        const invitation = {
          type: 'alliance_invite',
          from: country,
          to: targetCountry,
          allianceId: allianceId,
          allianceName: alliance.name,
          timestamp: new Date().toISOString(),
          status: 'pending'
        };

        await db.ref(`mail/${targetCountry}/${invitationId}`).set(invitation);
        showNotification(`Приглашение отправлено ${targetCountry}`);

      } catch (error) {
        showNotification('Ошибка отправки приглашения: ' + error.message, 'error');
      }
    }

    async function leaveAlliance() {
      if (!checkDB()) return;

      try {
        const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
        if (!allianceSnapshot.exists()) {
          showNotification('Вы не состоите в альянсе!', 'warning');
          return;
        }

        if (!confirm('Вы уверены, что хотите покинуть альянс?')) return;

        const allianceData = allianceSnapshot.val();
        const allianceId = Object.keys(allianceData)[0];
        const alliance = allianceData[allianceId];

        // Удаляем из альянса
        await db.ref(`alliances/${allianceId}/members/${country}`).remove();
        
        // Обновляем данные страны
        await db.ref(`countries/${country}`).update({
          alliance: null,
          lastUpdated: new Date().toISOString()
        });

        showNotification('Вы покинули альянс');
        loadAllianceInfo();

        // Уведомляем других участников
        sendAllianceNotification(`${country} покинул альянс`, 'system');

      } catch (error) {
        showNotification('Ошибка выхода из альянса: ' + error.message, 'error');
      }
    }

    // СИСТЕМА ВОЙН
    async function declareWar() {
      if (!checkDB()) {
        showNotification('База данных не доступна', 'error');
        return;
      }
      openWarModal();
    }

    async function confirmDeclareWar() {
      const targetCountry = document.getElementById('war-target').value;
      if (!targetCountry) {
        showNotification('Выберите страну', 'warning');
        return;
      }

      try {
        const warId = `${country}_vs_${targetCountry}_${Date.now()}`;
        const warData = {
          participants: {
            [country]: true,
            [targetCountry]: true
          },
          declaredBy: country,
          startTime: new Date().toISOString(),
          status: 'active'
        };

        await db.ref(`wars/${warId}`).set(warData);
        
        // Обновляем данные стран
        await db.ref(`countries/${country}/wars/${warId}`).set(true);
        await db.ref(`countries/${targetCountry}/wars/${warId}`).set(true);

        closeWarModal();
        showNotification(`Война объявлена ${targetCountry}!`, 'warning');

        // Отправляем уведомление о войне
        sendWarNotification(targetCountry, `${country} объявил вам войну!`);

      } catch (error) {
        showNotification('Ошибка объявления войны: ' + error.message, 'error');
      }
    }

    // СИСТЕМА УВЕДОМЛЕНИЙ
    async function sendAllianceNotification(message, type = 'alliance') {
      const mailId = `alliance_${Date.now()}`;
      const mailData = {
        type: type,
        subject: message,
        timestamp: new Date().toISOString(),
        read: false
      };

      // Отправляем всем участникам альянса
      const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
      if (allianceSnapshot.exists()) {
        const allianceData = allianceSnapshot.val();
        const allianceId = Object.keys(allianceData)[0];
        const members = allianceData[allianceId].members;

        Object.keys(members).forEach(member => {
          if (member !== country) {
            db.ref(`mail/${member}/${mailId}`).set(mailData);
          }
        });
      }
    }

    async function sendWarNotification(targetCountry, message) {
      const mailId = `war_${Date.now()}`;
      const mailData = {
        type: 'war',
        subject: message,
        from: country,
        timestamp: new Date().toISOString(),
        read: false
      };

      await db.ref(`mail/${targetCountry}/${mailId}`).set(mailData);
    }

    // ЗАГРУЗКА ИНФОРМАЦИИ ОБ АЛЬЯНСАХ И ВОЙНАХ
    async function loadAllianceInfo() {
      if (!checkDB()) return;

      try {
        // Загрузка информации об альянсе
        const allianceSnapshot = await db.ref(`alliances`).orderByChild('members/' + country).equalTo(true).once('value');
        const allianceContainer = document.getElementById('alliance-container');
        
        if (allianceSnapshot.exists()) {
          const allianceData = allianceSnapshot.val();
          const allianceId = Object.keys(allianceData)[0];
          const alliance = allianceData[allianceId];
          
          let html = `<div class="alliance-info">
            <h3>Альянс: ${alliance.name}</h3>
            <p>Создатель: ${alliance.creator}</p>
            <div class="alliance-members">
              <h4>Участники:</h4>`;
          
          Object.keys(alliance.members).forEach(member => {
            const isCreator = member === alliance.creator;
            html += `<div class="member-item">
              <span>${member} ${isCreator ? '👑' : ''}</span>
              ${isCreator && member === country ? `<button class="kick-btn" onclick="kickMember('${member}')" disabled>Исключить</button>` : 
                alliance.creator === country ? `<button class="kick-btn" onclick="kickMember('${member}')">Исключить</button>` : ''}
            </div>`;
          });
          
          html += `</div></div>`;
          allianceContainer.innerHTML = html;
        } else {
          allianceContainer.innerHTML = '';
        }

        // Загрузка информации о войнах
        const warsSnapshot = await db.ref(`countries/${country}/wars`).once('value');
        const warContainer = document.getElementById('war-container');
        
        if (warsSnapshot.exists()) {
          const wars = warsSnapshot.val();
          let html = `<div class="war-info"><h3>Активные войны:</h3>`;
          
          for (const warId in wars) {
            const warSnapshot = await db.ref(`wars/${warId}`).once('value');
            const war = warSnapshot.val();
            if (war && war.status === 'active') {
              const opponents = Object.keys(war.participants).filter(p => p !== country);
              html += `<p>Война с: ${opponents.join(', ')}</p>`;
            }
          }
          
          html += `</div>`;
          warContainer.innerHTML = html;
        } else {
          warContainer.innerHTML = '';
        }

      } catch (error) {
        console.error('Ошибка загрузки информации об альянсах/войнах:', error);
      }
    }

    // ЗАГРУЗКА ПОЧТЫ
    async function loadMail() {
      if (!checkDB()) return;

      try {
        const mailSnapshot = await db.ref(`mail/${country}`).orderByChild('timestamp').once('value');
        const mailContainer = document.getElementById('mail-container');
        
        if (!mailSnapshot.exists()) {
          mailContainer.innerHTML = '<div class="mail-item">Нет сообщений</div>';
          return;
        }

        let html = '';
        const mailData = mailSnapshot.val();
        
        Object.keys(mailData).sort((a, b) => new Date(mailData[b].timestamp) - new Date(mailData[a].timestamp))
          .forEach(mailId => {
            const mail = mailData[mailId];
            const date = new Date(mail.timestamp).toLocaleString();
            
            html += `<div class="mail-item">
              <div class="mail-sender">${mail.from || 'Система'}</div>
              <div class="mail-subject">${mail.subject}</div>
              <span class="mail-type ${mail.type}">${mail.type}</span>
              <div class="mail-date">${date}</div>`;
            
            if (mail.type === 'alliance_invite' && mail.status === 'pending') {
              html += `<div class="mail-actions">
                <button class="accept-btn" onclick="acceptInvitation('${mailId}', '${mail.allianceId}')">Принять</button>
                <button class="decline-btn" onclick="declineInvitation('${mailId}')">Отклонить</button>
              </div>`;
            }
            
            html += `</div>`;
          });
        
        mailContainer.innerHTML = html;
      } catch (error) {
        console.error('Ошибка загрузки почты:', error);
      }
    }

    // ОБРАБОТКА ПРИГЛАШЕНИЙ
    async function acceptInvitation(mailId, allianceId) {
      try {
        // Принимаем в альянс
        await db.ref(`alliances/${allianceId}/members/${country}`).set(true);
        await db.ref(`countries/${country}`).update({
          alliance: allianceId,
          lastUpdated: new Date().toISOString()
        });
        
        // Обновляем статус приглашения
        await db.ref(`mail/${country}/${mailId}/status`).set('accepted');
        
        showNotification('Вы приняли приглашение в альянс!');
        loadAllianceInfo();
        loadMail();
        
      } catch (error) {
        showNotification('Ошибка принятия приглашения: ' + error.message, 'error');
      }
    }

    async function declineInvitation(mailId) {
      try {
        await db.ref(`mail/${country}/${mailId}/status`).set('declined');
        showNotification('Приглашение отклонено');
        loadMail();
      } catch (error) {
        showNotification('Ошибка отклонения приглашения: ' + error.message, 'error');
      }
    }

    // УЛУЧШЕННАЯ СИСТЕМА ДОХОДА
    async function upgradeIncome() {
      if (!checkDB()) {
        showNotification('База данных не доступна', 'error');
        return;
      }
      
      try {
        const snapshot = await db.ref("countries/" + country).once("value");
        const data = snapshot.val();
        
        if (!data) {
          showNotification('Данные страны не найдены', 'error');
          return;
        }
        
        const currentGold = data.gold || 0;
        const currentIncome = data.income || 0;
        const upgradeCost = Math.floor(500 + (currentIncome * 10)); // Динамическая стоимость
        
        if (currentGold < upgradeCost) {
          showNotification(`Недостаточно золота! Нужно: ${upgradeCost}`, 'warning');
          return;
        }
        
        if (confirm(`Улучшить доход на 10 золота/час за ${upgradeCost} золота?`)) {
          const newIncome = currentIncome + 10;
          const newGold = currentGold - upgradeCost;
          
          await db.ref(`countries/${country}`).update({
            income: newIncome,
            gold: newGold,
            lastUpdated: new Date().toISOString()
          });
          
          showNotification(`✅ Доход улучшен! Теперь: ${newIncome}/час`);
        }
      } catch (error) {
        showNotification('Ошибка улучшения дохода: ' + error.message, 'error');
      }
    }

    // Остальные функции (initializeFirebase, checkDB, initializeCountryData, 
    // calculateOfflineIncome, loadData, startIncomeTimer, etc.) остаются прежними

    // Инициализация с загрузкой политических систем
    async function initialize() {
      if (initializeFirebase()) {
        await getServerTime();
        await initializeCountryData();
        loadData();
        loadAllianceInfo();
        loadMail();
        startIncomeTimer();
        
        setInterval(updateTimeDisplay, 1000);
        updateTimeDisplay();
        
        // Обновляем политическую информацию каждые 30 секунд
        setInterval(() => {
          loadAllianceInfo();
          loadMail();
        }, 30000);
      }
    }

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>–ê–ª–±–∞–Ω–∏—è ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script type="module">
/* Firebase + Firestore (v11) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* === –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π firebaseConfig (—Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç) === */
const firebaseConfig = {
  apiKey: "AIzaSyDRUoIzXpwwAGYM0qciAYdQm-wtMKqLsVs",
  authDomain: "strani3.firebaseapp.com",
  projectId: "strani3",
  storageBucket: "strani3.firebasestorage.app",
  messagingSenderId: "225168183800",
  appId: "1:225168183800:web:825e782a35bccca89d460d",
  measurementId: "G-3NKBET5R9J"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
const countryId = "albania"; // id –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ countries
const RESOURCE_TYPES = ["gold","food","steel","oil","energy","wood","stone","chips"];
const FACTORY_BASE_PRICE = { food:10, steel:20, oil:30, gold:50, energy:25, wood:15, stone:15, chips:40 };

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–Ω—ã, –µ—Å–ª–∏ –Ω–µ—Ç */
async function ensureCountryDoc(){
  const ref = doc(db, "countries", countryId);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref, {
      // —Ä–µ—Å—É—Ä—Å—ã
      gold: 100,
      food: 0,
      steel: 0,
      oil: 0,
      energy: 0,
      wood: 0,
      stone: 0,
      chips: 0,
      // —Ñ–∞–±—Ä–∏–∫–∏: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —É—Ä–æ–≤–Ω–∏
      factories: {
        food: 0, steel: 0, oil: 0, gold: 0, energy: 0, wood: 0, stone: 0, chips: 0
      },
      factoryLevel: {
        food:1, steel:1, oil:1, gold:1, energy:1, wood:1, stone:1, chips:1
      },
      // –ø—Ä–æ—á–µ–µ
      population: 2000000,
      income: 0,
      army: 0,
      alliance: "–Ω–µ—Ç",
      allianceLeader: false,
      createdAt: new Date()
    });
  }
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ UI */
async function updateUI(){
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();

  // —Ä–µ—Å—É—Ä—Å—ã
  RESOURCE_TYPES.forEach(k=>{
    const el = document.getElementById(k);
    if(el) el.textContent = (data[k] ?? 0);
  });

  // –Ω–∞—Å–µ–ª–µ–Ω–∏–µ/–¥–æ—Ö–æ–¥/–∞—Ä–º–∏—è/–∞–ª—å—è–Ω—Å
  document.getElementById("population").textContent = (data.population ?? 0).toLocaleString();
  document.getElementById("income").textContent = (data.income ?? 0);
  document.getElementById("army").textContent = (data.army ?? 0);
  document.getElementById("allianceName").textContent = (data.alliance ?? "–Ω–µ—Ç");

  // —Ñ–∞–±—Ä–∏–∫–∏ –∏ —É—Ä–æ–≤–Ω–∏ –≤ —Å—Ç—Ä–æ–π–∫–µ
  const factories = data.factories ?? {};
  const levels = data.factoryLevel ?? {};
  for(const t in factories){
    const countEl = document.getElementById("fcount-"+t);
    const lvlEl = document.getElementById("flvl-"+t);
    if(countEl) countEl.textContent = factories[t] ?? 0;
    if(lvlEl) lvlEl.textContent = "—É—Ä. "+(levels[t] ?? 1);
  }
}

/* –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—á—Ç—É (—Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã) */
async function loadMessages(){
  const q = query(collection(db,"messages"), where("to","==",countryId));
  const snaps = await getDocs(q);
  const box = document.getElementById("mailBox");
  box.innerHTML = "<h3>–ü–æ—á—Ç–∞</h3>";
  snaps.forEach(s=>{
    const d = s.data();
    const div = document.createElement("div");
    div.className = "mailItem";
    div.textContent = `[${d.type ?? "info"}] ${d.text}`;
    box.appendChild(div);
  });
}

/* –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–ª–æ—Ç–∞) */
async function buildFactory(type){
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const price = FACTORY_BASE_PRICE[type] ?? 10;
  if((data.gold ?? 0) < price){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞");
    return;
  }
  const newFactories = {...(data.factories||{})};
  newFactories[type] = (newFactories[type]||0) + 1;
  await updateDoc(ref, { gold: (data.gold||0) - price, factories: newFactories });
  await updateUI();
}

/* –ê–ø–≥—Ä–µ–π–¥ —Ñ–∞–±—Ä–∏–∫–∏: —Ü–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç —Å —É—Ä–æ–≤–Ω–µ–º (–∑–æ–ª–æ—Ç–æ + chips) */
async function upgradeFactory(type){
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const lvl = (data.factoryLevel && data.factoryLevel[type]) ? data.factoryLevel[type] : 1;
  const goldCost = Math.floor((FACTORY_BASE_PRICE[type]||10) * (1.5 * lvl));
  const chipsCost = Math.floor(5 * lvl);
  if((data.gold||0) < goldCost || (data.chips||0) < chipsCost){
    alert(`–ù—É–∂–Ω–æ ${goldCost} –∑–æ–ª–æ—Ç–∞ –∏ ${chipsCost} –º–∏–∫—Ä–æ—Å—Ö–µ–º`);
    return;
  }
  const newLevels = {...(data.factoryLevel||{})};
  newLevels[type] = lvl + 1;
  await updateDoc(ref, { gold: (data.gold||0) - goldCost, chips: (data.chips||0) - chipsCost, factoryLevel: newLevels });
  await updateUI();
}

/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤: –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–±—Ä–∏–∫ * —É—Ä–æ–≤–µ–Ω—å */
async function generateResources(){
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const factories = data.factories || {};
  const levels = data.factoryLevel || {};
  const delta = {};
  // –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞: –¥–æ–±–∞–≤–ª—è–µ–º factories[type] * level[type]
  for(const t in factories){
    const cnt = factories[t] || 0;
    const lvl = levels[t] || 1;
    const gain = cnt * lvl; // 1 –µ–¥–∏–Ω–∏—Ü–∞ * level * count –∫–∞–∂–¥—É—é 10s
    if(gain>0) delta[t] = (data[t]||0) + gain;
  }
  // –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ (—Å–æ—Ö—Ä–∞–Ω—è—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è)
  const newData = {};
  for(const k in delta) newData[k] = delta[k];
  if(Object.keys(newData).length) await updateDoc(ref,newData);
  await updateUI();
}

/* –ù–∞–ª–æ–≥–∏ –æ—Ç –Ω–∞—Å–µ–ª–µ–Ω–∏—è: –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ */
async function collectTaxes(){
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const tax = Math.floor((data.population || 0) / 1000); // 1 –∑–æ–ª–æ—Ç–æ –∑–∞ 1000 —á–µ–ª
  await updateDoc(ref, { gold: (data.gold||0) + tax });
  await updateUI();
}

/* –°–æ–∑–¥–∞—Ç—å –∞–ª—å—è–Ω—Å (–≤ document —Å—Ç—Ä–∞–Ω—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è alliance –∏ allianceLeader=true) */
async function createAlliance(){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞:");
  if(!name) return;
  const ref = doc(db,"countries",countryId);
  await updateDoc(ref, { alliance: name, allianceLeader: true });
  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Å–≤–æ–µ–π –ø–æ—á—Ç–µ
  await addDoc(collection(db,"messages"), { to: countryId, from: countryId, type:"info", text:`–í—ã —Å–æ–∑–¥–∞–ª–∏ –∞–ª—å—è–Ω—Å "${name}"`, date: new Date().toISOString() });
  await updateUI();
  await loadMessages();
}

/* –í—ã–π—Ç–∏ –∏–∑ –∞–ª—å—è–Ω—Å–∞ */
async function leaveAlliance(){
  const ref = doc(db,"countries",countryId);
  await updateDoc(ref, { alliance: "–Ω–µ—Ç", allianceLeader: false });
  await addDoc(collection(db,"messages"), { to: countryId, from: countryId, type:"info", text:`–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–ª—å—è–Ω—Å–∞`, date: new Date().toISOString() });
  await updateUI();
  await loadMessages();
}

/* –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∞–ª—å—è–Ω—Å –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–µ */
async function sendInvite(){
  const target = prompt("–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ? (id —Å—Ç—Ä–∞–Ω—ã)");
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  const data = snap.data();
  if(!target) return;
  if(!data.alliance || data.alliance==="–Ω–µ—Ç"){ alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∞–ª—å—è–Ω—Å"); return; }
  await addDoc(collection(db,"messages"), { to: target, from: countryId, type:"invite", alliance: data.alliance, text: `–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤ –∞–ª—å—è–Ω—Å ${data.alliance}`, date: new Date().toISOString() });
  alert("–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
}

/* –û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É ‚Äî –ø–∏—Å—å–º–æ –ø—Ä–∏–¥—ë—Ç –Ω–∞ –ø–æ—á—Ç—É —Ü–µ–ª–∏ */
async function declareWar(){
  const target = prompt("–ö–æ–º—É –æ–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É? (id —Å—Ç—Ä–∞–Ω—ã)");
  if(!target) return;
  await addDoc(collection(db,"messages"), { to: target, from: countryId, type:"war", text: `${countryId} –æ–±—ä—è–≤–ª—è–µ—Ç –≤–∞–º –≤–æ–π–Ω—É! –£ –≤–∞—Å –µ—Å—Ç—å –¥–µ–Ω—å –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É.`, date: new Date().toISOString() });
  await addDoc(collection(db,"messages"), { to: countryId, from: countryId, type:"info", text: `–í—ã –æ–±—ä—è–≤–∏–ª–∏ –≤–æ–π–Ω—É ${target}`, date: new Date().toISOString() });
  await loadMessages();
}

/* –í—ã–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω—É –∏–∑ –∞–ª—å—è–Ω—Å–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –ª–∏–¥–µ—Ä) */
async function kickFromAlliance(){
  const target = prompt("ID —Å—Ç—Ä–∞–Ω—ã, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –∞–ª—å—è–Ω—Å–∞");
  if(!target) return;
  // —É–ø—Ä–æ—Å—Ç–∏–º: –ø–æ–º–µ–Ω—è–µ–º –ø–æ–ª–µ alliance —É —Ü–µ–ª–∏ –Ω–∞ "–Ω–µ—Ç" –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∞ ‚Äî –ª–∏–¥–µ—Ä
  const myRef = doc(db,"countries",countryId);
  const mySnap = await getDoc(myRef);
  const myData = mySnap.data();
  if(!myData.alliance || myData.alliance==="–Ω–µ—Ç" || !myData.allianceLeader){
    alert("–í—ã –Ω–µ –ª–∏–¥–µ—Ä –∞–ª—å—è–Ω—Å–∞");
    return;
  }
  const targetRef = doc(db,"countries",target);
  const targetSnap = await getDoc(targetRef);
  if(!targetSnap.exists()){ alert("–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return; }
  const targetData = targetSnap.data();
  if(targetData.alliance !== myData.alliance){ alert("–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤ –≤–∞—à–µ–º –∞–ª—å—è–Ω—Å–µ"); return; }
  await updateDoc(targetRef, { alliance: "–Ω–µ—Ç", allianceLeader: false });
  await addDoc(collection(db,"messages"), { to: target, from: countryId, type:"info", text: `–í—ã –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –∞–ª—å—è–Ω—Å–∞ ${myData.alliance}`, date: new Date().toISOString() });
  alert("–°—Ç—Ä–∞–Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∞");
}

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI: –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã */
async function init(){
  await ensureCountryDoc();
  await updateUI();
  await loadMessages();

  // –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 10s) –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
  setInterval(async ()=>{
    await generateResources();
    await updateUI();
  }, 10000);

  // –Ω–∞–ª–æ–≥–∏ (–∫–∞–∂–¥—ã–µ 30s)
  setInterval(async ()=>{
    await collectTaxes();
    await updateUI();
  }, 30000);

  // –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–æ—á—Ç—É –∏ UI –∫–∞–∂–¥—ã–µ 10s
  setInterval(async ()=>{
    await loadMessages();
    await updateUI();
  }, 10000);
}

window.onload = init;

</script>

<style>
/* –°—Ç–∏–ª–∏ ‚Äî –¥–∏–∑–∞–π–Ω –∫–∞–∫ –Ω–∞ —Ç–≤–æ—ë–º —Ä–∏—Å—É–Ω–∫–µ */
:root{
  --bg:#0f0f12;
  --panel:#18181b;
  --panel-2:#1f1f24;
  --accent:#2dd4bf;
  --card:#232428;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:var(--bg); color:#e6eef6;
  height:100vh;
  display:grid;
  grid-template-columns:250px 1fr 260px;
  grid-template-rows:150px 1fr 80px;
  gap:16px;
  padding:16px;
}

/* resources top (spans columns) */
#resources{
  grid-column:1 / span 3;
  background:linear-gradient(180deg,#151516,#1b1b1f);
  border-radius:12px;
  padding:14px;
  display:flex;
  gap:18px;
  align-items:center;
  justify-content:space-around;
  box-shadow:0 6px 20px rgba(0,0,0,.6);
}

/* left mail */
#mailBox{
  grid-column:1;
  grid-row:2;
  background:var(--panel);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}

/* center main (actions content) */
#centerPanel{
  grid-column:2;
  grid-row:2;
  background:var(--panel-2);
  border-radius:10px;
  padding:14px;
  overflow:auto;
}

/* right ids */
#ids{
  grid-column:3;
  grid-row:2;
  background:var(--panel);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}

/* bottom actions */
#bottom{
  grid-column:1 / span 3;
  background:transparent;
  display:flex;
  justify-content:center;
  gap:18px;
  align-items:center;
}

/* cards */
.card{
  background:linear-gradient(180deg,#101012,#151518);
  border-radius:10px;
  padding:10px;
  box-shadow:0 6px 18px rgba(0,0,0,.6);
}

/* mail item */
.mailItem{
  background:#121214;
  padding:8px;
  border-radius:8px;
  margin-bottom:8px;
  color:var(--muted);
  font-size:14px;
}

/* factory grid */
.factoryGrid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px; }
.factoryItem{ background:#141417; padding:10px; border-radius:8px; display:flex;justify-content:space-between;align-items:center; }
.small{ font-size:13px; color:var(--muted); }

/* buttons */
.btn{
  background:linear-gradient(180deg,var(--accent),#10b981);
  border:0; color:#041014; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;
}
.btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,.06); color:var(--muted); }

/* responsive */
@media (max-width:900px){
  body{ grid-template-columns:1fr; grid-template-rows:auto auto auto auto; padding:10px;}
  #resources{ order:0}
  #mailBox, #centerPanel, #ids{ grid-column:auto; grid-row:auto;}
  #bottom{ order:4; margin-top:10px;}
}
</style>
</head>
<body>

  <!-- RESOURCES -->
  <div id="resources" class="card">
    <div>üí∞ <strong>–ó–æ–ª–æ—Ç–æ</strong>: <span id="gold">0</span></div>
    <div>üçû <strong>–ï–¥–∞</strong>: <span id="food">0</span></div>
    <div>‚öôÔ∏è <strong>–°—Ç–∞–ª—å</strong>: <span id="steel">0</span></div>
    <div>üõ¢ <strong>–ù–µ—Ñ—Ç—å</strong>: <span id="oil">0</span></div>
    <div>üîã <strong>–≠–Ω–µ—Ä–≥–∏—è</strong>: <span id="energy">0</span></div>
    <div>ü™µ <strong>–î–µ—Ä–µ–≤–æ</strong>: <span id="wood">0</span></div>
    <div>ü™® <strong>–ö–∞–º–µ–Ω—å</strong>: <span id="stone">0</span></div>
    <div>üí† <strong>–ú–∏–∫—Ä–æ—Å—Ö–µ–º—ã</strong>: <span id="chips">0</span></div>
    <div class="small">üë• –ù–∞—Å–µ–ª–µ–Ω–∏–µ: <span id="population">0</span></div>
    <div class="small">üìà –î–æ—Ö–æ–¥: <span id="income">0</span></div>
    <div class="small">‚öîÔ∏è –ê—Ä–º–∏—è: <span id="army">0</span></div>
    <div class="small">üõ° –ê–ª—å—è–Ω—Å: <span id="allianceName">–Ω–µ—Ç</span></div>
  </div>

  <!-- MAIL (left) -->
  <div id="mailBox" class="card">
    <h3>–ü–æ—á—Ç–∞</h3>
    <!-- —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
  </div>

  <!-- CENTER (building/politics modals content rendered here) -->
  <div id="centerPanel" class="card">
    <h2 id="centerTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–ª–±–∞–Ω–∏—è</h2>
    <div id="centerContent">
      <p class="small">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤–Ω–∏–∑—É: ¬´–ü–æ–ª–∏—Ç. –¥–µ–π—Å—Ç–≤–∏—è¬ª –∏–ª–∏ ¬´–°—Ç—Ä–æ–π–∫–∞¬ª</p>
    </div>
  </div>

  <!-- IDS (right) -->
  <div id="ids" class="card">
    <h3>ID —Å—Ç—Ä–∞–Ω</h3>
    <div class="small">
      <p>albania</p>
      <p>lithuania</p>
      <p>latvia</p>
      <p>estonia</p>
      <p>poland</p>
      <p>germany</p>
    </div>
  </div>

  <!-- bottom buttons -->
  <div id="bottom">
    <button class="btn" onclick="openPolitics()">–ü–æ–ª–∏—Ç. –¥–µ–π—Å—Ç–≤–∏—è</button>
    <button class="btn" onclick="openBuild()">–°—Ç—Ä–æ–π–∫–∞</button>
  </div>

  <!-- Hidden modals are rendered into centerPanel (simple, no separate overlay) -->

<script>
/* --- UI helpers –∏ –ª–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª–æ–∫ (centers) --- */

function setCenter(title, html){
  document.getElementById("centerTitle").textContent = title;
  document.getElementById("centerContent").innerHTML = html;
}

/* –ü–æ–ª–∏—Ç–∏–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å—è–Ω—Å–æ–º, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è, –≤–æ–π–Ω–∞ */
async function openPolitics(){
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : {};
  const alliance = data.alliance || "–Ω–µ—Ç";
  const isLeader = data.allianceLeader || false;

  let html = `<div>
    <p>–ê–ª—å—è–Ω—Å: <strong>${alliance}</strong></p>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" onclick="createAlliance()">–°–æ–∑–¥–∞—Ç—å –∞–ª—å—è–Ω—Å</button>
      <button class="btn ghost" onclick="leaveAlliance()">–í—ã–π—Ç–∏ –∏–∑ –∞–ª—å—è–Ω—Å–∞</button>
      <button class="btn ghost" onclick="sendInvite()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
      <button class="btn ghost" onclick="declareWar()">–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É</button>
    </div>
    <div style="margin-top:12px"><strong>–í—Ö–æ–¥—è—â–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è / —Å–æ–±—ã—Ç–∏—è</strong></div>
    <div id="invitesArea" class="small" style="margin-top:8px"></div>
  </div>`;
  setCenter("–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è", html);
  await loadMessages(); // –∑–∞–ø–æ–ª–Ω–∏—Ç –ø–æ—á—Ç—É —Å–ª–µ–≤–∞
  // –∑–∞–≥—Ä—É–∑–∏–º —Ç–æ–ª—å–∫–æ invites –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ invite)
  const q = query(collection(db,"messages"), where("to","==",countryId));
  const snaps = await getDocs(q);
  const invitesArea = document.getElementById("invitesArea");
  invitesArea.innerHTML = "";
  snaps.forEach(s=>{
    const d = s.data();
    if(d.type === "invite"){
      const div = document.createElement("div");
      div.className = "mailItem";
      div.innerHTML = `<div>${d.text}</div><div style="margin-top:6px"><button class="btn" onclick='acceptInvite("${d.from}","${d.alliance}")'>–ü—Ä–∏–Ω—è—Ç—å</button></div>`;
      invitesArea.appendChild(div);
    }
    if(d.type === "war"){
      const div = document.createElement("div");
      div.className = "mailItem";
      div.textContent = d.text;
      invitesArea.appendChild(div);
    }
  });
}

/* –ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (from ‚Äî –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª, alliance ‚Äî –∏–º—è –∞–ª—å—è–Ω—Å–∞) */
async function acceptInvite(from, allianceName){
  if(!confirm(`–ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∞–ª—å—è–Ω—Å "${allianceName}" –æ—Ç ${from}?`)) return;
  await updateDoc(doc(db,"countries",countryId), { alliance: allianceName });
  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
  await addDoc(collection(db,"messages"), { to: from, from: countryId, type:"info", text:`${countryId} –ø—Ä–∏–Ω—è–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ ${allianceName}` , date:new Date().toISOString() });
  await updateUI();
  await loadMessages();
  openPolitics();
}

/* –°—Ç—Ä–æ–π–∫–∞: –ø–æ—Å—Ç—Ä–æ–π–∫–∞ –∏ –∞–ø–≥—Ä–µ–π–¥—ã */
async function openBuild(){
  // –∑–∞–≥—Ä—É–∑–∏–º —É—Ä–æ–≤–Ω–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  const ref = doc(db,"countries",countryId);
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : {};
  const factories = data.factories || {};
  const levels = data.factoryLevel || {};
  let html = `<h4>–§–∞–±—Ä–∏–∫–∏</h4><div class="factoryGrid">`;
  const types = ["food","steel","oil","gold","energy","wood","stone","chips"];
  types.forEach(t=>{
    const cnt = factories[t] || 0;
    const lvl = levels[t] || 1;
    const price = FACTORY_BASE_PRICE[t] || 10;
    html += `<div class="factoryItem">
      <div>
        <strong>${t}</strong><div class="small">—à—Ç: <span id="fcount-${t}">${cnt}</span> <span id="flvl-${t}">—É—Ä. ${lvl}</span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn" onclick='buildFactory("${t}")'>–ü–æ—Å—Ç—Ä–æ–∏—Ç—å (${price}üí∞)</button>
        <button class="btn ghost" onclick='upgradeFactory("${t}")'>–ê–ø–≥—Ä–µ–π–¥</button>
      </div>
    </div>`;
  });
  html += `</div>`;
  setCenter("–°—Ç—Ä–æ–π–∫–∏", html);
  await updateUI(); // —á—Ç–æ–±—ã —á–∏—Å–ª–∞ –±—ã–ª–∏ —Å–≤–µ–∂–∏–µ
}

/* == –ù–∞—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã Firebase ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤—ã—à–µ: buildFactory, upgradeFactory, createAlliance, leaveAlliance, sendInvite, declareWar == */
/* –î–æ–±–∞–≤–∏–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–æ–Ω–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤—ã—à–µ). */

/* --- –î–æ–ø: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—á—Ç—É –≤ —Ü–µ–Ω—Ç—Ä–µ (—É–¥–æ–±—Å—Ç–≤–æ) --- */
async function openMailCenter(){
  setCenter("–ü–æ—á—Ç–∞", `<div id="centerMailArea" class="small"></div>`);
  await loadMessages();
  // –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫–æ –≤ —Ü–µ–Ω—Ç—Ä
  const q = query(collection(db,"messages"), where("to","==",countryId));
  const snaps = await getDocs(q);
  const area = document.getElementById("centerMailArea");
  area.innerHTML = "";
  snaps.forEach(s=>{
    const d = s.data();
    const div = document.createElement("div");
    div.className = "mailItem";
    div.textContent = `[${d.type}] ${d.text}`;
    area.appendChild(div);
  });
}

/* expose helper functions to buttons in HTML */
window.openPolitics = openPolitics;
window.openBuild = openBuild;
window.createAlliance = createAlliance;
window.leaveAlliance = leaveAlliance;
window.sendInvite = sendInvite;
window.declareWar = declareWar;
window.kickFromAlliance = kickFromAlliance;
window.buildFactory = buildFactory;
window.upgradeFactory = upgradeFactory;
window.openMailCenter = openMailCenter;

</script>
</body>
</html>

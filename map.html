<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∏–∫—Å–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ï–≤—Ä–æ–ø—ã</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c1a, #1a1a2e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.25), rgba(39, 174, 96, 0.2));
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.15);
        }

        h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3498db, #2ecc71, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }

        .map-container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .pixel-map {
            display: grid;
            grid-template-columns: repeat(24, 30px);
            grid-template-rows: repeat(20, 30px);
            gap: 1px;
            background: #2a2a40;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #3a3a5a;
            position: relative;
        }

        .pixel {
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .pixel:hover {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 0 2px #f39c12, 0 0 15px rgba(243, 156, 18, 0.5);
        }

        .pixel.empty {
            background: transparent;
        }

        .pixel-border {
            position: absolute;
            background: rgba(255,255,255,0.8);
            z-index: 5;
        }

        .border-top { top: -1px; left: 0; width: 100%; height: 1px; }
        .border-right { top: 0; right: -1px; width: 1px; height: 100%; }
        .border-bottom { bottom: -1px; left: 0; width: 100%; height: 1px; }
        .border-left { top: 0; left: -1px; width: 1px; height: 100%; }

        .controls {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-group {
            margin-bottom: 25px;
        }

        h2 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        h3 {
            color: #2ecc71;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .legend {
            display: grid;
            grid-template-columns: 20px 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .status-info {
            background: rgba(52, 152, 219, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .region-details {
            background: rgba(39, 174, 96, 0.15);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #27ae60;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label {
            font-weight: bold;
            color: #bdc3c7;
        }

        .detail-value {
            color: #ecf0f1;
            font-weight: 500;
        }

        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #3498db;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.08);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .country-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #3498db;
        }

        .coordinates {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß± –ü–∏–∫—Å–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ï–≤—Ä–æ–ø—ã</h1>
            <div style="opacity: 0.9;">–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã —Å –ø–∏–∫—Å–µ–ª—å–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ ‚Ä¢ Real-time –¥–∞–Ω–Ω—ã–µ</div>
        </header>

        <div class="content">
            <div class="map-container">
                <div class="filters">
                    <button class="filter-btn active" onclick="setFilter('all')">üåç –í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</button>
                    <button class="filter-btn" onclick="setFilter('wars')">‚öîÔ∏è –í–æ–µ–Ω–Ω—ã–µ</button>
                    <button class="filter-btn" onclick="setFilter('rich')">üí∞ –ë–æ–≥–∞—Ç—ã–µ</button>
                </div>
                <div class="pixel-map" id="pixel-map">
                    <!-- –ü–∏–∫—Å–µ–ª–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <h2>üé® –õ–µ–≥–µ–Ω–¥–∞ –∫–∞—Ä—Ç—ã</h2>
                    <div class="legend">
                        <div class="color-box" style="background-color: #27ae60;"></div>
                        <span>–ú–∏—Ä–Ω—ã–π —Ä–µ–≥–∏–æ–Ω</span>
                    </div>
                    <div class="legend">
                        <div class="color-box" style="background-color: #e74c3c;"></div>
                        <span>–†–µ–≥–∏–æ–Ω –≤ –≤–æ–π–Ω–µ</span>
                    </div>
                    <div class="legend">
                        <div class="color-box" style="background-color: #3498db;"></div>
                        <span>–í—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥</span>
                    </div>
                    <div class="legend">
                        <div class="color-box" style="background-color: #f39c12;"></div>
                        <span>–°–∏–ª—å–Ω–∞—è –∞—Ä–º–∏—è</span>
                    </div>
                    <div class="legend">
                        <div class="color-box" style="background-color: #9b59b6;"></div>
                        <span>–ú–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤</span>
                    </div>
                    <div class="legend">
                        <div class="color-box" style="background-color: #7f8c8d;"></div>
                        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    </div>
                </div>

                <div class="control-group">
                    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
                    <div class="status-info">
                        <div class="detail-item">
                            <span class="detail-label">–°—Ç–∞—Ç—É—Å:</span>
                            <span class="detail-value" id="sync-status">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="regions-count">0</div>
                                <div class="stat-label">–†–µ–≥–∏–æ–Ω–æ–≤</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="countries-count">0</div>
                                <div class="stat-label">–°—Ç—Ä–∞–Ω</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="wars-count">0</div>
                                <div class="stat-label">–í–æ–π–Ω</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="alliances-count">0</div>
                                <div class="stat-label">–ê–ª—å—è–Ω—Å–æ–≤</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h2>üìç –î–µ—Ç–∞–ª–∏ —Ä–µ–≥–∏–æ–Ω–∞</h2>
                    <div class="region-details" id="region-details">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; margin-bottom: 10px;">üß±</div>
                            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</h3>
                            <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –∫–≤–∞–¥—Ä–∞—Ç –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDRUoIzXpwwAGYM0qciAYdQm-wtMKqLsVs",
            authDomain: "strani3.firebaseapp.com",
            databaseURL: "https://strani3-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "strani3",
            storageBucket: "strani3.firebasestorage.app",
            messagingSenderId: "225168183800",
            appId: "1:225168183800:web:825e782a35bccca89d460d",
            measurementId: "G-3NKBET5R9J"
        };

        let db;
        let countriesData = {};
        let currentFilter = 'all';
        let selectedPixel = null;

        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω –ø–æ –ø–∏–∫—Å–µ–ª—è–º (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã x,y)
        const countryPixels = {
            // –ó–∞–ø–∞–¥–Ω–∞—è –ï–≤—Ä–æ–ø–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã
            'france': [
                [5,8],[6,8],[7,8],[8,8],
                [5,9],[6,9],[7,9],[8,9],
                [5,10],[6,10],[7,10]
            ],
            'germany': [
                [9,7],[10,7],[11,7],[12,7],
                [9,8],[10,8],[11,8],[12,8],
                [10,9],[11,9],[12,9]
            ],
            'united_kingdom': [
                [2,5],[3,5],[4,5],
                [2,6],[3,6],[4,6],
                [3,7]
            ],
            'spain': [
                [3,9],[4,9],[5,9],
                [3,10],[4,10],[5,10],[6,10],
                [4,11],[5,11]
            ],
            'italy': [
                [10,10],[11,10],
                [10,11],[11,11],[12,11],
                [11,12]
            ],
            
            // –°–µ–≤–µ—Ä–Ω–∞—è –ï–≤—Ä–æ–ø–∞
            'sweden': [
                [10,3],[11,3],[12,3],
                [10,4],[11,4],[12,4],
                [11,5]
            ],
            'norway': [
                [9,2],[10,2],
                [9,3],[10,3],
                [9,4]
            ],
            'finland': [
                [13,3],[14,3],
                [13,4],[14,4],[15,4],
                [13,5],[14,5]
            ],
            'denmark': [
                [9,6],[10,6],
                [9,7]
            ],
            
            // –í–æ—Å—Ç–æ—á–Ω–∞—è –ï–≤—Ä–æ–ø–∞
            'poland': [
                [12,7],[13,7],[14,7],
                [12,8],[13,8],[14,8],
                [12,9],[13,9]
            ],
            'ukraine': [
                [15,7],[16,7],[17,7],
                [15,8],[16,8],[17,8],
                [15,9],[16,9]
            ],
            'romania': [
                [13,9],[14,9],[15,9],
                [13,10],[14,10],[15,10]
            ],
            
            // –ë–∞–ª–∫–∞–Ω—ã
            'greece': [
                [13,12],[14,12],
                [13,13],[14,13]
            ],
            'serbia': [
                [12,10],[13,10],
                [12,11]
            ],
            'croatia': [
                [11,9],[12,9],
                [11,10]
            ],
            'bulgaria': [
                [14,10],[15,10],
                [14,11],[15,11]
            ],
            'albania': [
                [12,12]
            ],
            
            // –ë–∞–ª—Ç–∏–π—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            'lithuania': [
                [13,6],[14,6]
            ],
            'latvia': [
                [12,5],[13,5]
            ],
            'estonia': [
                [13,4],[14,4]
            ],
            
            // –ë–µ–Ω–∏–ª—é–∫—Å
            'netherlands': [
                [8,6],[9,6]
            ],
            'belgium': [
                [8,7],[9,7]
            ],
            'luxembourg': [
                [9,8]
            ],
            
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ï–≤—Ä–æ–ø–∞
            'austria': [
                [11,8],[12,8]
            ],
            'switzerland': [
                [9,9]
            ],
            'czechia': [
                [11,7],[12,7]
            ],
            'slovakia': [
                [13,8]
            ],
            'hungary': [
                [12,9],[13,9]
            ],
            
            // –î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã
            'portugal': [
                [2,10],[3,10],
                [2,11],[3,11]
            ],
            'ireland': [
                [1,6],[2,6],
                [1,7],[2,7]
            ],
            'belarus': [
                [14,5],[15,5],
                [14,6],[15,6]
            ],
            'moldova': [
                [15,9]
            ],
            'montenegro': [
                [12,11]
            ],
            'slovenia': [
                [11,9]
            ],
            'bosnia': [
                [11,10]
            ],
            'iceland': [
                [0,2],[1,2],
                [0,3],[1,3]
            ],
            'malta': [
                [11,13]
            ],
            'cyprus': [
                [17,12]
            ],
            'andorra': [
                [4,9]
            ],
            'monaco': [
                [8,10]
            ],
            'san_marino': [
                [10,10]
            ],
            'liechtenstein': [
                [10,8]
            ]
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        function initializeFirebase() {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                updateStatus("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω");
                return true;
            } catch (error) {
                updateStatus("‚ùå –û—à–∏–±–∫–∞ Firebase: " + error.message);
                return false;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message) {
            document.getElementById('sync-status').textContent = message;
            console.log(message);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
        function loadCountriesData() {
            if (!db) return;

            updateStatus("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω...");
            
            db.ref("countries").on("value", (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    countriesData = data;
                    updateStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(data).length} —Å—Ç—Ä–∞–Ω`);
                    createPixelMap();
                    updateStatistics();
                } else {
                    updateStatus("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                }
            });

            db.ref("wars").on("value", () => {
                updateStatistics();
                updatePixelColors();
            });

            db.ref("alliances").on("value", () => {
                updateStatistics();
                updatePixelColors();
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        function createPixelMap() {
            const pixelMap = document.getElementById('pixel-map');
            pixelMap.innerHTML = '';

            // –°–æ–∑–¥–∞–µ–º 24x20 —Å–µ—Ç–∫—É
            for (let y = 0; y < 20; y++) {
                for (let x = 0; x < 24; x++) {
                    const pixel = document.createElement('div');
                    pixel.className = 'pixel empty';
                    pixel.dataset.x = x;
                    pixel.dataset.y = y;
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–∞–Ω—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–∏–∫—Å–µ–ª—è
                    const country = findCountryForPixel(x, y);
                    if (country) {
                        pixel.dataset.country = country;
                        pixel.dataset.region = `${country}_${x}_${y}`;
                        pixel.textContent = getCountryCode(country);
                    }
                    
                    pixel.addEventListener('click', handlePixelClick);
                    pixel.addEventListener('mouseenter', handlePixelHover);
                    pixel.addEventListener('mouseleave', handlePixelLeave);
                    
                    pixelMap.appendChild(pixel);
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∞–º–∏
            addCountryBorders();
            updatePixelColors();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
        function addCountryBorders() {
            const pixels = document.querySelectorAll('.pixel:not(.empty)');
            
            pixels.forEach(pixel => {
                const x = parseInt(pixel.dataset.x);
                const y = parseInt(pixel.dataset.y);
                const country = pixel.dataset.country;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å–µ–¥–µ–π –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                const neighbors = [
                    {dx: 0, dy: -1, border: 'top'},    // —Å–≤–µ—Ä—Ö—É
                    {dx: 1, dy: 0, border: 'right'},   // —Å–ø—Ä–∞–≤–∞
                    {dx: 0, dy: 1, border: 'bottom'},  // —Å–Ω–∏–∑—É
                    {dx: -1, dy: 0, border: 'left'}    // —Å–ª–µ–≤–∞
                ];

                neighbors.forEach(neighbor => {
                    const nx = x + neighbor.dx;
                    const ny = y + neighbor.dy;
                    
                    if (isValidCoordinate(nx, ny)) {
                        const neighborCountry = findCountryForPixel(nx, ny);
                        if (neighborCountry !== country) {
                            // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É
                            const border = document.createElement('div');
                            border.className = `pixel-border border-${neighbor.border}`;
                            pixel.appendChild(border);
                        }
                    } else {
                        // –ì—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã
                        const border = document.createElement('div');
                        border.className = `pixel-border border-${neighbor.border}`;
                        border.style.background = '#5a5a7a'; // –ë–æ–ª–µ–µ —Ç–µ–º–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –∫—Ä–∞—è –∫–∞—Ä—Ç—ã
                        pixel.appendChild(border);
                    }
                });
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function isValidCoordinate(x, y) {
            return x >= 0 && x < 24 && y >= 0 && y < 20;
        }

        // –ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω—ã –¥–ª—è –ø–∏–∫—Å–µ–ª—è
        function findCountryForPixel(x, y) {
            for (const [country, pixels] of Object.entries(countryPixels)) {
                if (pixels.some(([px, py]) => px === x && py === y)) {
                    return country;
                }
            }
            return null;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞
        function getRegionData(countryId, x, y) {
            const countryData = countriesData[countryId];
            if (!countryData) {
                return {
                    population: 0,
                    army: 0,
                    gold: 0,
                    income: 0,
                    hasWars: false,
                    inAlliance: false
                };
            }

            const basePopulation = countryData.population || 0;
            const baseArmy = countryData.army || 0;
            const baseGold = countryData.gold || 0;
            const hasWars = countryData.wars && Object.keys(countryData.wars).length > 0;
            const inAlliance = !!countryData.alliance;

            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
            const regionCoefficient = ((x * 7 + y * 13) % 10) / 10 + 0.5;

            return {
                population: Math.floor(basePopulation * regionCoefficient / getCountryRegionCount(countryId)),
                army: Math.floor(baseArmy * regionCoefficient / getCountryRegionCount(countryId)),
                gold: Math.floor(baseGold * regionCoefficient / getCountryRegionCount(countryId)),
                income: Math.floor((basePopulation * regionCoefficient / getCountryRegionCount(countryId)) / 100000),
                hasWars: hasWars,
                inAlliance: inAlliance
            };
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –≤ —Å—Ç—Ä–∞–Ω–µ
        function getCountryRegionCount(countryId) {
            return countryPixels[countryId] ? countryPixels[countryId].length : 1;
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ä–µ–≥–∏–æ–Ω–∞
        function getRegionColor(regionData) {
            if (regionData.population === 0) return '#7f8c8d';
            if (regionData.hasWars) return '#e74c3c';
            if (regionData.income > 30) return '#3498db';
            if (regionData.army > 100) return '#f39c12';
            if (regionData.gold > 500) return '#9b59b6';
            return '#27ae60';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø–∏–∫—Å–µ–ª–µ–π
        function updatePixelColors() {
            const pixels = document.querySelectorAll('.pixel:not(.empty)');
            
            pixels.forEach(pixel => {
                const countryId = pixel.dataset.country;
                const x = parseInt(pixel.dataset.x);
                const y = parseInt(pixel.dataset.y);
                const regionData = getRegionData(countryId, x, y);
                const color = getRegionColor(regionData);
                
                let shouldShow = true;
                if (currentFilter === 'wars' && !regionData.hasWars) {
                    shouldShow = false;
                } else if (currentFilter === 'rich' && regionData.income <= 20) {
                    shouldShow = false;
                }

                pixel.style.opacity = shouldShow ? '1' : '0.3';
                pixel.style.background = color;
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        function getCountryCode(countryId) {
            const codes = {
                'france': 'FR', 'germany': 'DE', 'united_kingdom': 'UK', 'spain': 'ES', 'italy': 'IT',
                'sweden': 'SE', 'norway': 'NO', 'finland': 'FI', 'denmark': 'DK', 'poland': 'PL',
                'ukraine': 'UA', 'romania': 'RO', 'greece': 'GR', 'serbia': 'RS', 'croatia': 'HR',
                'bulgaria': 'BG', 'albania': 'AL', 'lithuania': 'LT', 'latvia': 'LV', 'estonia': 'EE',
                'netherlands': 'NL', 'belgium': 'BE', 'luxembourg': 'LU', 'austria': 'AT', 'switzerland': 'CH',
                'czechia': 'CZ', 'slovakia': 'SK', 'hungary': 'HU', 'portugal': 'PT', 'ireland': 'IE',
                'belarus': 'BY', 'moldova': 'MD', 'montenegro': 'ME', 'slovenia': 'SI', 'bosnia': 'BA',
                'iceland': 'IS', 'malta': 'MT', 'cyprus': 'CY', 'andorra': 'AD', 'monaco': 'MC',
                'san_marino': 'SM', 'liechtenstein': 'LI'
            };
            return codes[countryId] || countryId.substring(0, 2).toUpperCase();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics() {
            const countriesCount = Object.keys(countriesData).length;
            const regionsCount = Object.values(countryPixels).reduce((acc, pixels) => acc + pixels.length, 0);
            const warsCount = calculateWarsCount();
            const alliancesCount = calculateAlliancesCount();
            
            document.getElementById('countries-count').textContent = countriesCount;
            document.getElementById('regions-count').textContent = regionsCount;
            document.getElementById('wars-count').textContent = warsCount;
            document.getElementById('alliances-count').textContent = alliancesCount;
        }

        function calculateWarsCount() {
            let wars = 0;
            Object.values(countriesData).forEach(country => {
                if (country.wars && Object.keys(country.wars).length > 0) wars++;
            });
            return wars;
        }

        function calculateAlliancesCount() {
            let alliances = 0;
            Object.values(countriesData).forEach(country => {
                if (country.alliance) alliances++;
            });
            return alliances;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function handlePixelClick(event) {
            const pixel = event.target;
            const countryId = pixel.dataset.country;
            const x = parseInt(pixel.dataset.x);
            const y = parseInt(pixel.dataset.y);
            
            if (countryId) {
                showRegionInfo(countryId, x, y);
            }
        }

        function handlePixelHover(event) {
            if (event.target !== selectedPixel) {
                event.target.style.transform = 'scale(1.15)';
            }
        }

        function handlePixelLeave(event) {
            if (event.target !== selectedPixel) {
                event.target.style.transform = 'scale(1)';
            }
        }

        // –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–≥–∏–æ–Ω–µ
        function showRegionInfo(countryId, x, y) {
            const regionData = getRegionData(countryId, x, y);
            const detailsElement = document.getElementById('region-details');
            
            const countryNames = {
                'france': '–§—Ä–∞–Ω—Ü–∏—è', 'germany': '–ì–µ—Ä–º–∞–Ω–∏—è', 'united_kingdom': '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
                'spain': '–ò—Å–ø–∞–Ω–∏—è', 'italy': '–ò—Ç–∞–ª–∏—è', 'sweden': '–®–≤–µ—Ü–∏—è', 'norway': '–ù–æ—Ä–≤–µ–≥–∏—è',
                'finland': '–§–∏–Ω–ª—è–Ω–¥–∏—è', 'denmark': '–î–∞–Ω–∏—è', 'poland': '–ü–æ–ª—å—à–∞', 'ukraine': '–£–∫—Ä–∞–∏–Ω–∞',
                'romania': '–†—É–º—ã–Ω–∏—è', 'greece': '–ì—Ä–µ—Ü–∏—è', 'serbia': '–°–µ—Ä–±–∏—è', 'croatia': '–•–æ—Ä–≤–∞—Ç–∏—è',
                'bulgaria': '–ë–æ–ª–≥–∞—Ä–∏—è', 'albania': '–ê–ª–±–∞–Ω–∏—è', 'lithuania': '–õ–∏—Ç–≤–∞', 'latvia': '–õ–∞—Ç–≤–∏—è',
                'estonia': '–≠—Å—Ç–æ–Ω–∏—è', 'netherlands': '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', 'belgium': '–ë–µ–ª—å–≥–∏—è', 'luxembourg': '–õ—é–∫—Å–µ–º–±—É—Ä–≥',
                'austria': '–ê–≤—Å—Ç—Ä–∏—è', 'switzerland': '–®–≤–µ–π—Ü–∞—Ä–∏—è', 'czechia': '–ß–µ—Ö–∏—è', 'slovakia': '–°–ª–æ–≤–∞–∫–∏—è',
                'hungary': '–í–µ–Ω–≥—Ä–∏—è', 'portugal': '–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è', 'ireland': '–ò—Ä–ª–∞–Ω–¥–∏—è', 'belarus': '–ë–µ–ª–∞—Ä—É—Å—å',
                'moldova': '–ú–æ–ª–¥–æ–≤–∞', 'montenegro': '–ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è', 'slovenia': '–°–ª–æ–≤–µ–Ω–∏—è', 'bosnia': '–ë–æ—Å–Ω–∏—è –∏ –ì–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞',
                'iceland': '–ò—Å–ª–∞–Ω–¥–∏—è', 'malta': '–ú–∞–ª—å—Ç–∞', 'cyprus': '–ö–∏–ø—Ä', 'andorra': '–ê–Ω–¥–æ—Ä—Ä–∞',
                'monaco': '–ú–æ–Ω–∞–∫–æ', 'san_marino': '–°–∞–Ω-–ú–∞—Ä–∏–Ω–æ', 'liechtenstein': '–õ–∏—Ö—Ç–µ–Ω—à—Ç–µ–π–Ω'
            };

            detailsElement.innerHTML = `
                <div class="country-name">${countryNames[countryId] || countryId}</div>
                <div class="coordinates">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: [${x}, ${y}]</div>
                
                <div class="detail-item">
                    <span class="detail-label">üë• –ù–∞—Å–µ–ª–µ–Ω–∏–µ:</span>
                    <span class="detail-value">${regionData.population.toLocaleString()}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üí∞ –î–æ—Ö–æ–¥/—á–∞—Å:</span>
                    <span class="detail-value">${regionData.income} –∑–æ–ª–æ—Ç–∞</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">‚öîÔ∏è –ê—Ä–º–∏—è:</span>
                    <span class="detail-value">${regionData.army} —Å–æ–ª–¥–∞—Ç</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üè¶ –ó–æ–ª–æ—Ç–æ:</span>
                    <span class="detail-value">${regionData.gold}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">üïäÔ∏è –°—Ç–∞—Ç—É—Å:</span>
                    <span class="detail-value">${regionData.hasWars ? '‚öîÔ∏è –í–æ–π–Ω–∞' : 'üïäÔ∏è –ú–∏—Ä'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ü§ù –ê–ª—å—è–Ω—Å:</span>
                    <span class="detail-value">${regionData.inAlliance ? '‚úÖ –í –∞–ª—å—è–Ω—Å–µ' : '‚ùå –ù–µ –≤ –∞–ª—å—è–Ω—Å–µ'}</span>
                </div>
            `;

            if (selectedPixel) {
                selectedPixel.style.boxShadow = 'none';
            }
            
            selectedPixel = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
            if (selectedPixel) {
                selectedPixel.style.boxShadow = '0 0 0 3px #f39c12, 0 0 20px rgba(243, 156, 18, 0.7)';
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updatePixelColors();
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function initialize() {
            if (initializeFirebase()) {
                loadCountriesData();
                setInterval(() => {
                    updatePixelColors();
                    updateStatistics();
                }, 10000);
            }
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

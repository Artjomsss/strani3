<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∏–∫—Å–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ï–≤—Ä–æ–ø—ã</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c1a, #1a1a2e);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            max-width: 95vw;
            margin: 0 auto;
            height: 95vh;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.25), rgba(39, 174, 96, 0.2));
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.15);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3498db, #2ecc71, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: calc(95vh - 150px);
        }

        .map-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .map-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 10px;
            position: relative;
            cursor: grab;
        }

        .map-wrapper:active {
            cursor: grabbing;
        }

        .pixel-map {
            display: grid;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            transition: transform 0.1s ease;
            background: #2a2a40;
            padding: 30px;
            border-radius: 10px;
        }

        .pixel {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            border: 1px solid rgba(0,0,0,0.4);
            user-select: none;
        }

        .pixel:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 0 2px #f39c12, 0 0 15px rgba(243, 156, 18, 0.5);
        }

        .pixel.empty {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .pixel-border {
            position: absolute;
            background: rgba(0,0,0,0.9);
            z-index: 5;
            pointer-events: none;
        }

        .border-top { top: -1px; left: 0; width: 100%; height: 2px; }
        .border-right { top: 0; right: -1px; width: 2px; height: 100%; }
        .border-bottom { bottom: -1px; left: 0; width: 100%; height: 2px; }
        .border-left { top: 0; left: -1px; width: 2px; height: 100%; }

        .thick-border {
            background: rgba(0,0,0,0.9);
            z-index: 6;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑—É–º–æ–º */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(52, 152, 219, 0.8);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .zoom-btn:hover {
            background: rgba(52, 152, 219, 1);
            transform: scale(1.1);
        }

        .zoom-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .controls {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
        }

        h2 {
            color: #3498db;
            margin-bottom: 12px;
            font-size: 1.3em;
        }

        h3 {
            color: #2ecc71;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .legend {
            display: grid;
            grid-template-columns: 20px 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
        }

        .color-picker {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
        }

        .status-info {
            background: rgba(52, 152, 219, 0.15);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3498db;
        }

        .region-details {
            background: rgba(39, 174, 96, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #27ae60;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label {
            font-weight: bold;
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .detail-value {
            color: #ecf0f1;
            font-weight: 500;
            font-size: 0.9em;
        }

        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .filter-btn {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-btn.active {
            background: #3498db;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        .stat-item {
            background: rgba(255,255,255,0.08);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8em;
            color: #bdc3c7;
        }

        .country-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #3498db;
        }

        .coordinates {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .country-colors-legend {
            display: grid;
            grid-template-columns: 1fr;
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
        }

        .country-color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            font-size: 0.8em;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            margin-bottom: 2px;
        }

        .color-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .reset-colors {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            margin-top: 8px;
        }

        .reset-colors:hover {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß± –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –ï–≤—Ä–æ–ø—ã</h1>
            <div style="opacity: 0.9;">–£–≤–µ–ª–∏—á—å—Ç–µ –º–∞—Å—à—Ç–∞–±, –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∏ –º–µ–Ω—è–π—Ç–µ —Ü–≤–µ—Ç–∞ ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –¥–ª—è –∑—É–º–∞</div>
        </header>

        <div class="content">
            <div class="map-container">
                <div class="map-wrapper" id="map-wrapper">
                    <div class="pixel-map" id="pixel-map">
                        <!-- –ü–∏–∫—Å–µ–ª–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                    <button class="zoom-btn" onclick="resetZoom()">‚ü≤</button>
                </div>
                
                <div class="zoom-display" id="zoom-display">–ú–∞—Å—à—Ç–∞–±: 100%</div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <h2>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤</h2>
                    <div class="color-control">
                        <input type="color" id="color-picker" class="color-picker" value="#3498db">
                        <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</span>
                    </div>
                    <button class="reset-colors" onclick="resetAllColors()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ü–≤–µ—Ç–∞</button>
                </div>

                <div class="control-group">
                    <h2>üåç –¶–≤–µ—Ç–∞ —Å—Ç—Ä–∞–Ω</h2>
                    <div class="country-colors-legend" id="country-colors-legend">
                        <!-- –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>

                <div class="control-group">
                    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="status-info">
                        <div class="detail-item">
                            <span class="detail-label">–°—Ç–∞—Ç—É—Å:</span>
                            <span class="detail-value" id="sync-status">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="regions-count">0</div>
                                <div class="stat-label">–†–µ–≥–∏–æ–Ω–æ–≤</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="countries-count">0</div>
                                <div class="stat-label">–°—Ç—Ä–∞–Ω</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h2>üìç –î–µ—Ç–∞–ª–∏ —Ä–µ–≥–∏–æ–Ω–∞</h2>
                    <div class="region-details" id="region-details">
                        <div style="text-align: center; padding: 15px;">
                            <div style="font-size: 2em; margin-bottom: 8px;">üß±</div>
                            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</h3>
                            <p style="font-size: 0.8em;">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –∫–≤–∞–¥—Ä–∞—Ç –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDRUoIzXpwwAGYM0qciAYdQm-wtMKqLsVs",
            authDomain: "strani3.firebaseapp.com",
            databaseURL: "https://strani3-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "strani3",
            storageBucket: "strani3.firebasestorage.app",
            messagingSenderId: "225168183800",
            appId: "1:225168183800:web:825e782a35bccca89d460d",
            measurementId: "G-3NKBET5R9J"
        };

        let db;
        let countriesData = {};
        let selectedPixel = null;
        let currentScale = 1.0;
        let currentTranslate = { x: 0, y: 0 };
        let isDragging = false;
        let lastMousePos = { x: 0, y: 0 };
        let selectedCountryForColor = null;

        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω—ã
        const defaultCountryColors = {
            'france': '#1f77b4', 'germany': '#ff7f0e', 'united_kingdom': '#2ca02c',
            'spain': '#d62728', 'italy': '#9467bd', 'sweden': '#8c564b',
            'norway': '#e377c2', 'finland': '#7f7f7f', 'denmark': '#bcbd22',
            'poland': '#17becf', 'ukraine': '#aec7e8', 'romania': '#ffbb78',
            'greece': '#98df8a', 'serbia': '#ff9896', 'croatia': '#c5b0d5',
            'bulgaria': '#c49c94', 'albania': '#f7b6d2', 'lithuania': '#c7c7c7',
            'latvia': '#dbdb8d', 'estonia': '#9edae5', 'netherlands': '#393b79',
            'belgium': '#637939', 'luxembourg': '#8c6d31', 'austria': '#843c39',
            'switzerland': '#7b4173', 'czechia': '#5254a3', 'slovakia': '#8ca252',
            'hungary': '#bd9e39', 'portugal': '#ad494a', 'ireland': '#a55194',
            'belarus': '#6b6ecf', 'moldova': '#b5cf6b', 'montenegro': '#e7ba52',
            'slovenia': '#ce6dbd', 'bosnia': '#9c9ede', 'iceland': '#cedb9c',
            'malta': '#e7cb94', 'cyprus': '#e7969c', 'andorra': '#7b4173',
            'monaco': '#843c39', 'san_marino': '#8c6d31', 'liechtenstein': '#637939'
        };

        let countryColors = {...defaultCountryColors};

        // –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω –ø–æ –ø–∏–∫—Å–µ–ª—è–º (48x40 –≤–º–µ—Å—Ç–æ 24x20)
        const countryPixels = {
            'france': generateExpandedPixels([
                [10,16],[11,16],[12,16],[13,16],[14,16],[15,16],
                [10,17],[11,17],[12,17],[13,17],[14,17],[15,17],
                [10,18],[11,18],[12,18],[13,18],[14,18],[15,18],
                [10,19],[11,19],[12,19],[13,19],[14,19],
                [10,20],[11,20],[12,20],[13,20],[14,20]
            ]),
            'germany': generateExpandedPixels([
                [18,14],[19,14],[20,14],[21,14],[22,14],[23,14],
                [18,15],[19,15],[20,15],[21,15],[22,15],[23,15],
                [18,16],[19,16],[20,16],[21,16],[22,16],[23,16],
                [19,17],[20,17],[21,17],[22,17],[23,17],
                [20,18],[21,18],[22,18],[23,18]
            ]),
            'united_kingdom': generateExpandedPixels([
                [4,10],[5,10],[6,10],[7,10],[8,10],
                [4,11],[5,11],[6,11],[7,11],[8,11],
                [4,12],[5,12],[6,12],[7,12],[8,12],
                [5,13],[6,13],[7,13],[8,13],
                [6,14],[7,14]
            ]),
            'spain': generateExpandedPixels([
                [6,18],[7,18],[8,18],[9,18],[10,18],
                [6,19],[7,19],[8,19],[9,19],[10,19],[11,19],
                [6,20],[7,20],[8,20],[9,20],[10,20],[11,20],
                [7,21],[8,21],[9,21],[10,21],[11,21],
                [8,22],[9,22],[10,22]
            ]),
            'italy': generateExpandedPixels([
                [20,20],[21,20],[22,20],[23,20],
                [20,21],[21,21],[22,21],[23,21],[24,21],
                [20,22],[21,22],[22,22],[23,22],[24,22],
                [21,23],[22,23],[23,23],[24,23],
                [22,24],[23,24]
            ])
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function generateExpandedPixels(originalPixels) {
            const expanded = [];
            originalPixels.forEach(([x, y]) => {
                // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ 4 –ø–∏–∫—Å–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–∏–∫—Å–µ–ª—è
                expanded.push([x*2, y*2], [x*2 + 1, y*2], [x*2, y*2 + 1], [x*2 + 1, y*2 + 1]);
            });
            return expanded;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        function initializeFirebase() {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                updateStatus("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω");
                return true;
            } catch (error) {
                updateStatus("‚ùå –û—à–∏–±–∫–∞ Firebase: " + error.message);
                return false;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message) {
            document.getElementById('sync-status').textContent = message;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
        function loadCountriesData() {
            if (!db) return;

            updateStatus("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω...");
            
            db.ref("countries").on("value", (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    countriesData = data;
                    updateStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(data).length} —Å—Ç—Ä–∞–Ω`);
                    createPixelMap();
                    updateStatistics();
                    createCountryColorsLegend();
                } else {
                    updateStatus("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                }
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–∞–Ω
        function createCountryColorsLegend() {
            const legendElement = document.getElementById('country-colors-legend');
            legendElement.innerHTML = '';

            Object.entries(countryColors).forEach(([countryId, color]) => {
                if (countryPixels[countryId]) {
                    const countryName = getCountryName(countryId);
                    const item = document.createElement('div');
                    item.className = 'country-color-item';
                    item.innerHTML = `
                        <div class="color-box" style="background-color: ${color};" 
                             onclick="selectCountryForColor('${countryId}')"></div>
                        <span>${countryName}</span>
                        <input type="color" value="${color}" 
                               onchange="changeCountryColor('${countryId}', this.value)" 
                               style="margin-left: auto; width: 25px; height: 20px;">
                    `;
                    legendElement.appendChild(item);
                }
            });
        }

        // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã –¥–ª—è —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–∞
        function selectCountryForColor(countryId) {
            selectedCountryForColor = countryId;
            const colorPicker = document.getElementById('color-picker');
            colorPicker.value = countryColors[countryId];
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã
            document.querySelectorAll('.pixel').forEach(pixel => {
                if (pixel.dataset.country === countryId) {
                    pixel.style.boxShadow = '0 0 0 2px #f39c12, 0 0 10px rgba(243, 156, 18, 0.5)';
                } else {
                    pixel.style.boxShadow = 'none';
                }
            });
        }

        // –°–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ —Å—Ç—Ä–∞–Ω—ã
        function changeCountryColor(countryId, newColor) {
            countryColors[countryId] = newColor;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
            document.querySelectorAll(`.pixel[data-country="${countryId}"]`).forEach(pixel => {
                pixel.style.background = newColor;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
            createCountryColorsLegend();
        }

        // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
        function resetAllColors() {
            countryColors = {...defaultCountryColors};
            createCountryColorsLegend();
            updatePixelColors();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã
        function createPixelMap() {
            const pixelMap = document.getElementById('pixel-map');
            pixelMap.innerHTML = '';

            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—É—é —Å–µ—Ç–∫—É 48x40
            const gridSizeX = 48;
            const gridSizeY = 40;
            const pixelSize = 25; // –†–∞–∑–º–µ—Ä –ø–∏–∫—Å–µ–ª—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö

            pixelMap.style.gridTemplateColumns = `repeat(${gridSizeX}, ${pixelSize}px)`;
            pixelMap.style.gridTemplateRows = `repeat(${gridSizeY}, ${pixelSize}px)`;

            for (let y = 0; y < gridSizeY; y++) {
                for (let x = 0; x < gridSizeX; x++) {
                    const pixel = document.createElement('div');
                    pixel.className = 'pixel empty';
                    pixel.dataset.x = x;
                    pixel.dataset.y = y;
                    
                    const country = findCountryForPixel(x, y);
                    if (country) {
                        pixel.dataset.country = country;
                        pixel.dataset.region = `${country}_${x}_${y}`;
                        pixel.textContent = getCountryCode(country);
                        pixel.style.background = countryColors[country];
                    }
                    
                    pixel.addEventListener('click', handlePixelClick);
                    
                    pixelMap.appendChild(pixel);
                }
            }
            
            addCountryBorders();
            setupZoomAndPan();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑—É–º–∞ –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è
        function setupZoomAndPan() {
            const mapWrapper = document.getElementById('map-wrapper');
            const pixelMap = document.getElementById('pixel-map');

            // –ó—É–º –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏
            mapWrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomIntensity = 0.1;
                const wheel = e.deltaY < 0 ? 1 : -1;
                const zoom = Math.exp(wheel * zoomIntensity);
                
                const rect = mapWrapper.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                currentTranslate.x -= (mouseX - currentTranslate.x) * (zoom - 1);
                currentTranslate.y -= (mouseY - currentTranslate.y) * (zoom - 1);
                currentScale *= zoom;
                
                updateMapTransform();
            });

            // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
            mapWrapper.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
                    isDragging = true;
                    lastMousePos = { x: e.clientX, y: e.clientY };
                    mapWrapper.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastMousePos.x;
                    const deltaY = e.clientY - lastMousePos.y;
                    
                    currentTranslate.x += deltaX;
                    currentTranslate.y += deltaY;
                    
                    lastMousePos = { x: e.clientX, y: e.clientY };
                    updateMapTransform();
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                mapWrapper.style.cursor = 'grab';
            });

            // –°–µ–Ω—Å–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            let touchStart = null;
            mapWrapper.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            mapWrapper.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && touchStart) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - touchStart.x;
                    const deltaY = touch.clientY - touchStart.y;
                    
                    currentTranslate.x += deltaX;
                    currentTranslate.y += deltaY;
                    
                    touchStart = { x: touch.clientX, y: touch.clientY };
                    updateMapTransform();
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
        function updateMapTransform() {
            const pixelMap = document.getElementById('pixel-map');
            pixelMap.style.transform = `translate(${currentTranslate.x}px, ${currentTranslate.y}px) scale(${currentScale})`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞
            document.getElementById('zoom-display').textContent = `–ú–∞—Å—à—Ç–∞–±: ${Math.round(currentScale * 100)}%`;
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º
        function zoomIn() {
            currentScale *= 1.2;
            updateMapTransform();
        }

        function zoomOut() {
            currentScale /= 1.2;
            updateMapTransform();
        }

        function resetZoom() {
            currentScale = 1.0;
            currentTranslate = { x: 0, y: 0 };
            updateMapTransform();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø–∏–∫—Å–µ–ª–µ–π
        function updatePixelColors() {
            document.querySelectorAll('.pixel:not(.empty)').forEach(pixel => {
                const countryId = pixel.dataset.country;
                pixel.style.background = countryColors[countryId];
            });
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ—Ö–æ–∂–∏–º–∏, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ —É–≤–µ–ª–∏—á–µ–Ω–Ω—É—é –∫–∞—Ä—Ç—É
        function addCountryBorders() {
            const pixels = document.querySelectorAll('.pixel:not(.empty)');
            
            pixels.forEach(pixel => {
                const x = parseInt(pixel.dataset.x);
                const y = parseInt(pixel.dataset.y);
                const country = pixel.dataset.country;

                const neighbors = [
                    {dx: 0, dy: -1, border: 'top'},
                    {dx: 1, dy: 0, border: 'right'},
                    {dx: 0, dy: 1, border: 'bottom'},
                    {dx: -1, dy: 0, border: 'left'}
                ];

                neighbors.forEach(neighbor => {
                    const nx = x + neighbor.dx;
                    const ny = y + neighbor.dy;
                    
                    if (isValidCoordinate(nx, ny)) {
                        const neighborCountry = findCountryForPixel(nx, ny);
                        if (neighborCountry !== country) {
                            const border = document.createElement('div');
                            border.className = `pixel-border border-${neighbor.border} thick-border`;
                            pixel.appendChild(border);
                        }
                    } else {
                        const border = document.createElement('div');
                        border.className = `pixel-border border-${neighbor.border}`;
                        border.style.background = '#000000';
                        pixel.appendChild(border);
                    }
                });
            });
        }

        function isValidCoordinate(x, y) {
            return x >= 0 && x < 48 && y >= 0 && y < 40;
        }

        function findCountryForPixel(x, y) {
            for (const [country, pixels] of Object.entries(countryPixels)) {
                if (pixels.some(([px, py]) => px === x && py === y)) {
                    return country;
                }
            }
            return null;
        }

        function getCountryCode(countryId) {
            const codes = {
                'france': 'FR', 'germany': 'DE', 'united_kingdom': 'UK',
                'spain': 'ES', 'italy': 'IT', 'sweden': 'SE', 'norway': 'NO'
            };
            return codes[countryId] || countryId.substring(0, 2).toUpperCase();
        }

        function getCountryName(countryId) {
            const names = {
                'france': '–§—Ä–∞–Ω—Ü–∏—è', 'germany': '–ì–µ—Ä–º–∞–Ω–∏—è', 'united_kingdom': '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
                'spain': '–ò—Å–ø–∞–Ω–∏—è', 'italy': '–ò—Ç–∞–ª–∏—è', 'sweden': '–®–≤–µ—Ü–∏—è', 'norway': '–ù–æ—Ä–≤–µ–≥–∏—è'
            };
            return names[countryId] || countryId;
        }

        function updateStatistics() {
            const countriesCount = Object.keys(countriesData).length;
            const regionsCount = Object.values(countryPixels).reduce((acc, pixels) => acc + pixels.length, 0);
            
            document.getElementById('countries-count').textContent = countriesCount;
            document.getElementById('regions-count').textContent = regionsCount;
        }

        function handlePixelClick(event) {
            const pixel = event.target;
            const countryId = pixel.dataset.country;
            const x = parseInt(pixel.dataset.x);
            const y = parseInt(pixel.dataset.y);
            
            if (countryId) {
                showRegionInfo(countryId, x, y);
            }
        }

        function showRegionInfo(countryId, x, y) {
            const detailsElement = document.getElementById('region-details');
            detailsElement.innerHTML = `
                <div class="country-name">${getCountryName(countryId)}</div>
                <div class="coordinates">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: [${x}, ${y}]</div>
                <div style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
                    üé® –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ü–≤–µ—Ç —Å—Ç—Ä–∞–Ω—ã –≤ –ª–µ–≥–µ–Ω–¥–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ
                </div>
            `;

            if (selectedPixel) {
                selectedPixel.style.boxShadow = 'none';
            }
            
            selectedPixel = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
            if (selectedPixel) {
                selectedPixel.style.boxShadow = '0 0 0 3px #f39c12, 0 0 20px rgba(243, 156, 18, 0.7)';
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function initialize() {
            if (initializeFirebase()) {
                loadCountriesData();
            }
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
